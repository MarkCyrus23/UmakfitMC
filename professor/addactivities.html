<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UmakFit - Add Activities</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { 
            font-family: 'Inter', Helvetica, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f6f6f6;
        }
        
        /* Navigation styles */
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        .loading-text {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #475569;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Card styles */
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            min-width: 80px;
        }
        .status-active {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-scheduled {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .status-completed {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        /* Rating Badges */
        .rating-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
        }
        .rating-excellent {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .rating-good {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .rating-fair {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        /* Action Buttons */
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-family: "Inter", Helvetica;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .btn-edit {
            background: #1e40af;
            color: white;
        }
        .btn-edit:hover {
            background: #1e3a8a;
        }
        .btn-cancel {
            background: linear-gradient(180deg, rgba(245, 158, 11, 1) 0%, rgba(251, 191, 36, 1) 100%);
            color: white;
        }
        .btn-cancel:hover {
            background: linear-gradient(180deg, rgba(217, 119, 6, 1) 0%, rgba(245, 158, 11, 1) 100%);
        }
        .btn-view {
            background: #10b981;
            color: white;
        }
        .btn-view:hover {
            background: #059669;
        }
        
        /* Empty State */
        .empty-state {
            padding: 60px 40px;
            text-align: center;
            background: #f8fafc;
            border-radius: 8px;
            margin: 20px;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.4;
            color: #64748b;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Table Styles */
        .custom-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .custom-table thead {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.9) 0%, rgba(59, 130, 246, 0.9) 100%);
        }
        .custom-table th {
            font-family: "Inter", Helvetica;
            font-weight: 600;
            color: white;
            font-size: 14px;
            text-align: left;
            padding: 15px 12px;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .custom-table td {
            font-family: "Inter", Helvetica;
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .custom-table tbody tr {
            transition: all 0.3s;
        }
        .custom-table tbody tr:hover {
            background-color: #f8fafc;
        }
        
        /* Progress bar */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 8px;
            border-radius: 20px;
            transition: width 0.3s ease;
        }
        .progress-bar-green {
            background-color: #10b981;
        }
        .progress-bar-yellow {
            background-color: #f59e0b;
        }
        .progress-bar-blue {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Activities Management...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation Banner - MATCHING ADD LESSON PAGE EXACTLY -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 py-3 sm:py-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <!-- Dashboard -->
                        <a href="professor.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-tachometer-alt"></i> 
                            <span>Dashboard</span>
                        </a>
                        
                        <!-- Student Management -->
                        <a href="studentmanagement.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-users"></i> 
                            <span>Student Management</span>
                        </a>
                        
                        <!-- Add Activities -->
                        <a href="addactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-dumbbell"></i> 
                            <span>Add Activities</span>
                        </a>
                        
                        <!-- Add Lesson -->
                        <a href="addlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-book-open"></i> 
                            <span>Add Lesson</span>
                        </a>
                        
                        <!-- Monitoring Activities -->
                        <a href="monitoringactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-chart-bar"></i> 
                            <span>Monitoring Activities</span>
                        </a>
                        
                        <!-- Grades -->
                        <a href="grades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-graduation-cap"></i> 
                            <span>Grades</span>
                        </a>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2 pb-3">
                    <a href="professor.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </a>
                    <a href="studentmanagement.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-users mr-2"></i> Student Management
                    </a>
                    <a href="addactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-dumbbell mr-2"></i> Add Activities
                    </a>
                    <a href="addlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-book-open mr-2"></i> Add Lesson
                    </a>
                    <a href="monitoringactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-chart-bar mr-2"></i> Monitoring Activities
                    </a>
                    <a href="grades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-graduation-cap mr-2"></i> Grades
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header - MATCHING ADD LESSON STYLE -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-4">
                            <i class="fas fa-dumbbell text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-blue-900 font-bold text-3xl">Test Management</h1>
                            <p class="text-gray-600 font-medium text-base mt-2">Schedule fitness tests, track progress, and manage student assessments</p>
                        </div>
                    </div>
                </div>

                <!-- My Test Schedule Section -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-calendar-check"></i>
                            My Test Schedule
                        </h3>
                        <button class="mt-2 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="showScheduleTestModal()">
                            <i class="fas fa-plus"></i>
                            <span>Schedule New Test</span>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="searchSchedule" placeholder="Search by Test Name or Section..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               onkeyup="filterScheduleTable()">
                    </div>
                    
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="custom-table w-full">
                            <thead>
                                <tr>
                                    <th>Test Name</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Deadline</th>
                                    <th>Progress</th>
                                    <th>Attempts Allowed</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">ðŸ“…</div>
                                            <div class="font-semibold text-gray-700 mb-1">No Scheduled Tests</div>
                                            <div class="text-gray-500 text-sm">You haven't scheduled any tests yet. Click "Schedule New Test" to create your first fitness test schedule.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Test Results Section -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-chart-line"></i>
                            Recent Test Results
                        </h3>
                        <button class="mt-2 sm:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all" onclick="generateReports()">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Reports</span>
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="text" id="searchResults" placeholder="Search by student name..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               onkeyup="filterResultsTable()">
                        
                        <select id="filterSection" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterResultsTable()">
                            <option value="">All Sections</option>
                        </select>
                        
                        <select id="filterTest" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filterResultsTable()">
                            <option value="">All Tests</option>
                        </select>
                        
                        <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm transition-all" onclick="clearResultFilters()">
                            <i class="fas fa-redo"></i> Clear Filters
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="custom-table w-full">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Section</th>
                                    <th>Date</th>
                                    <th>Test</th>
                                    <th>Score</th>
                                    <th>BMI</th>
                                    <th>Rating</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="empty-state">
                                            <div class="empty-icon">ðŸ“Š</div>
                                            <div class="font-semibold text-gray-700 mb-1">No Test Results Yet</div>
                                            <div class="text-gray-500 text-sm">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Test Modal -->
    <div id="scheduleTestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-calendar-plus"></i> Schedule New Test
                </h3>
                <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeScheduleTestModal()">&times;</button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">
                            <i class="fab fa-youtube text-red-500"></i> Instruction Video URL (Optional)
                        </label>
                        <input type="url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               id="videoURL" placeholder="https://www.youtube.com/watch?v=...">
                        <p class="text-gray-500 text-xs mt-1">ðŸ“º Paste a YouTube video link for test instructions (optional)</p>
                        <p class="text-blue-500 text-xs mt-1">ðŸ’¡ Tip: Upload your video to YouTube first, then copy the link here</p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">
                            Test Type <span class="text-red-500">*</span>
                        </label>
                        <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="testType" required>
                            <option value="">Select Test Type</option>
                            <option value="3-Minute Step Test">3-Minute Step Test</option>
                            <option value="Curl-Up Test">Curl-Up Test</option>
                            <option value="Push-Up Test">Push-Up Test</option>
                            <option value="Sit-and-Reach">Sit-and-Reach Test</option>
                            <option value="Skinfold Caliper">Skinfold Caliper Measurements</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">
                            Section <span class="text-red-500">*</span>
                        </label>
                        <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="testSection" required>
                            <option value="">Select Section</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Test Date</label>
                            <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="testDate">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Deadline Date</label>
                            <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="testDeadline">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Deadline Time</label>
                            <input type="time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="testDeadlineTime" value="23:59">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Attempts Allowed</label>
                            <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="attemptsAllowed">
                                <option value="1">1 Attempt</option>
                                <option value="2">2 Attempts</option>
                                <option value="3">3 Attempts</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="testTargetGroup" style="display: none;">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" id="testTargetLabel">Test Target</label>
                        <input type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               id="testTarget" min="1">
                        <p class="text-gray-500 text-xs mt-1" id="testTargetHint"></p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Additional Instructions (Optional)</label>
                        <textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                  id="testInstructions" rows="3" placeholder="Add any specific instructions for this test..."></textarea>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all" onclick="closeScheduleTestModal()">Cancel</button>
                <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all" onclick="scheduleTest()">Schedule Test</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Modal -->
    <div id="editTestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-edit"></i> Edit Test
                </h3>
                <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeEditTestModal()">&times;</button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Test Type</label>
                        <input type="text" class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" id="editTestName" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Section</label>
                        <input type="text" class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" id="editTestSection" readonly>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Test Date <span class="text-red-500">*</span></label>
                            <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="editTestDate" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-2">Deadline Date <span class="text-red-500">*</span></label>
                            <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="editTestDeadline" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Deadline Time <span class="text-red-500">*</span></label>
                        <input type="time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="editTestDeadlineTime" required>
                    </div>
                    
                    <div id="editTestTargetGroup" style="display: none;">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" id="editTestTargetLabel">Test Target <span class="text-red-500">*</span></label>
                        <input type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="editTestTarget" min="1">
                        <p class="text-gray-500 text-xs mt-1" id="editTestTargetHint"></p>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Attempts Allowed</label>
                        <input type="text" class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" id="editAttemptsAllowed" readonly>
                    </div>
                    
                    <input type="hidden" id="editTestId">
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all" onclick="closeEditTestModal()">Cancel</button>
                <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all" onclick="saveEditTest()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Result Details Modal -->
    <div id="resultDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i> Test Result Details
                </h3>
                <button class="text-gray-500 hover:text-gray-700 text-2xl" onclick="closeResultDetailsModal()">&times;</button>
            </div>
            <div class="p-6" id="resultDetailsContent">
                <!-- Result details will be loaded here -->
            </div>
            <div class="flex justify-end p-6 border-t border-gray-200">
                <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all" onclick="closeResultDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { 
            initializeApp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            getDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            orderBy,
            serverTimestamp,
            limit,
            Timestamp,
            onSnapshot
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.serverTimestamp = serverTimestamp;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.Timestamp = Timestamp;
        window.onSnapshot = onSnapshot;
        window.deleteDoc = deleteDoc;

        // Global variables
        window.currentUser = null;
        window.assignedSections = [];
        window.scheduledTests = [];
        window.testResults = [];
        window.filteredTests = [];
        window.filteredResults = [];

        // Navigation functions
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        // Mobile menu toggle
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                document.body.classList.add('dropdown-open');
            } else {
                dropdown.classList.add('hidden');
                document.body.classList.remove('dropdown-open');
            }
        }

        function closeProfileDropdown() {
            profileDropdown.classList.add('hidden');
            profileDropdownMobile.classList.add('hidden');
            document.body.classList.remove('dropdown-open');
        }

        // Close all dropdowns when clicking outside
        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', toggleMobileMenu);
            }
            
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            document.addEventListener('click', closeAllDropdowns);
        });

        // View profile function
        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        // Logout function
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        // Function to update profile picture
        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = userName || 'Professor';
            const email = window.currentUser?.email || 'professor@umak.edu.ph';
            
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Authentication state change handler
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('Activities management loading for:', user.email);
                    window.currentUser = user;
                    
                    // Update profile picture
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    // Load data
                    await loadAssignedSections();
                    await loadScheduledTests();
                    await loadTestResults();
                    
                    // Setup real-time updates
                    setupRealTimeUpdates();
                    
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error loading activities management:', error);
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    alert('Error loading data: ' + error.message);
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        // Load assigned sections
        async function loadAssignedSections() {
            try {
                window.assignedSections = [];
                
                let professorName = '';
                let professorEmail = window.currentUser.email;
                
                // Try to get professor name from professors collection
                const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
                const profSnap = await getDocs(profQuery);
                if (!profSnap.empty) {
                    professorName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
                }
                
                // If not found, try users collection
                if (!professorName) {
                    const userQuery = query(collection(db, 'users'), where('email', '==', professorEmail));
                    const userSnap = await getDocs(userQuery);
                    if (!userSnap.empty) {
                        const userData = userSnap.docs[0].data();
                        if (userData.role === 'professor') {
                            professorName = userData.fullName || userData.name || window.currentUser.displayName;
                        }
                    }
                }
                
                // Fallback
                if (!professorName) {
                    professorName = window.currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
                }
                
                // Load sections
                const sectionsSnapshot = await getDocs(collection(db, 'sections'));
                
                sectionsSnapshot.forEach(sectionDoc => {
                    const data = sectionDoc.data();
                    const dbProfessor = (data.professor || '').toString().trim();
                    
                    // Flexible matching
                    const matches = 
                        dbProfessor === professorName ||
                        dbProfessor.toUpperCase().includes(professorName.toUpperCase()) ||
                        professorName.toUpperCase().includes(dbProfessor.toUpperCase()) ||
                        dbProfessor.replace(/[,.\s]/g, '') === professorName.replace(/[,.\s]/g, '');
                    
                    if (matches) {
                        const studentCount = Array.isArray(data.students) ? data.students.length : 0;
                        
                        window.assignedSections.push({
                            id: sectionDoc.id,
                            name: data.name,
                            studentCount: studentCount,
                            courseCode: data.courseCode || 'PE 3'
                        });
                    }
                });
                
                console.log(`âœ“ Loaded ${window.assignedSections.length} assigned sections`);
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

        // Load scheduled tests
        async function loadScheduledTests() {
            try {
                if (!window.currentUser) return;
                
                window.scheduledTests = [];
                
                const testsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('professorEmail', '==', window.currentUser.email)
                );
                
                const testsSnapshot = await getDocs(testsQuery);
                
                testsSnapshot.forEach(docSnap => {
                    const test = docSnap.data();
                    window.scheduledTests.push({
                        id: docSnap.id,
                        ...test,
                        deadlineDateTime: test.deadlineDateTime ? new Date(test.deadlineDateTime) : null
                    });
                });
                
                window.filteredTests = [...window.scheduledTests];
                displayScheduledTests();
                
            } catch (error) {
                console.error('Error loading scheduled tests:', error);
            }
        }

        // Display scheduled tests
        function displayScheduledTests() {
            const tableBody = document.getElementById('scheduleTableBody');
            
            if (window.filteredTests.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“…</div>
                                <div class="font-semibold text-gray-700 mb-1">No Scheduled Tests</div>
                                <div class="text-gray-500 text-sm">You haven't scheduled any tests yet. Click "Schedule New Test" to create your first fitness test schedule.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            window.filteredTests.forEach(test => {
                const now = new Date();
                const deadline = test.deadlineDateTime;
                const isOverdue = deadline && deadline < now;
                
                let status = test.status || 'scheduled';
                if (isOverdue && status !== 'completed') {
                    status = 'overdue';
                }
                
                const statusClass = status === 'active' ? 'status-active' : 
                                 status === 'completed' ? 'status-completed' : 
                                 status === 'overdue' ? 'status-scheduled' : 
                                 'status-scheduled';
                
                const statusText = status === 'active' ? 'Active' : 
                                status === 'completed' ? 'Completed' : 
                                status === 'overdue' ? 'Overdue' : 
                                'Scheduled';
                
                const totalStudents = test.totalStudents || 0;
                const completedStudents = test.completedStudents || 0;
                const progressPercentage = totalStudents > 0 ? Math.round((completedStudents / totalStudents) * 100) : 0;
                
                let progressBarColor = 'progress-bar-green';
                if (progressPercentage < 50) {
                    progressBarColor = 'progress-bar-yellow';
                } else if (progressPercentage < 70) {
                    progressBarColor = 'progress-bar-blue';
                }
                
                html += `
                    <tr>
                        <td>
                            <strong style="color: #1e3a8a;">${test.testName || 'Unnamed Test'}</strong>
                            ${isOverdue ? '<br><small style="color: #ef4444;">âš ï¸ Past deadline</small>' : ''}
                        </td>
                        <td>${test.section || 'N/A'}</td>
                        <td>${test.date || 'N/A'}</td>
                        <td>${test.deadline || 'N/A'} ${test.deadlineTime || ''}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 80px;">
                                    <div class="progress-container">
                                        <div class="progress-bar ${progressBarColor}" style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>
                                <span style="font-size: 12px;">${completedStudents}/${totalStudents}</span>
                            </div>
                        </td>
                        <td>${test.attemptsAllowed || '1'}</td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-edit" onclick="editTest('${test.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-action btn-cancel" onclick="deleteTest('${test.id}')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // Load test results
        async function loadTestResults() {
            try {
                if (!window.currentUser) return;
                
                window.testResults = [];
                
                // Get results from assigned sections
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    orderBy('submittedAt', 'desc'),
                    limit(100)
                );
                
                const resultsSnapshot = await getDocs(resultsQuery);
                
                resultsSnapshot.forEach(docSnap => {
                    const result = docSnap.data();
                    window.testResults.push({
                        id: docSnap.id,
                        ...result,
                        submittedAt: result.submittedAt?.toDate() || new Date()
                    });
                });
                
                window.filteredResults = [...window.testResults];
                displayTestResults();
                
                // Populate filter dropdowns
                populateFilterDropdowns();
                
            } catch (error) {
                console.error('Error loading test results:', error);
            }
        }

        // Display test results
        function displayTestResults() {
            const tableBody = document.getElementById('resultsTableBody');
            
            if (window.filteredResults.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“Š</div>
                                <div class="font-semibold text-gray-700 mb-1">No Test Results Yet</div>
                                <div class="text-gray-500 text-sm">No students have completed tests yet. Test results will appear here once students start taking and completing their fitness assessments.</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            window.filteredResults.slice(0, 50).forEach(result => {
                const score = result.score || calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                
                const bmi = result.bmi || 'N/A';
                const date = result.submittedAt ? 
                    result.submittedAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
                    'N/A';
                
                html += `
                    <tr>
                        <td>
                            <strong style="color: #1e3a8a;">${result.studentName || 'Unknown Student'}</strong><br>
                            <small style="color: #64748b;">${result.studentEmail || ''}</small>
                        </td>
                        <td>${result.section || 'N/A'}</td>
                        <td>${date}</td>
                        <td>
                            <strong>${result.testName || 'Unknown Test'}</strong><br>
                            ${result.attemptNumber ? `<small style="color: #64748b;">Attempt ${result.attemptNumber}</small>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 700; font-size: 16px; color: ${score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444'}">
                                ${score}%
                            </span>
                        </td>
                        <td>${bmi}</td>
                        <td>
                            <span class="rating-badge ${rating.class}">${rating.text}</span>
                        </td>
                        <td>
                            <button class="btn-action btn-view" onclick="viewResultDetails('${result.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            const sectionFilter = document.getElementById('filterSection');
            const testFilter = document.getElementById('filterTest');
            
            // Clear existing options
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            testFilter.innerHTML = '<option value="">All Tests</option>';
            
            // Get unique sections from results
            const uniqueSections = new Set();
            const uniqueTests = new Set();
            
            window.testResults.forEach(result => {
                if (result.section) uniqueSections.add(result.section);
                if (result.testName) uniqueTests.add(result.testName);
            });
            
            // Add section options
            uniqueSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
            
            // Add test options
            uniqueTests.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                testFilter.appendChild(option);
            });
        }

        // Filter schedule table
        window.filterScheduleTable = function() {
            const searchTerm = document.getElementById('searchSchedule').value.toLowerCase();
            
            window.filteredTests = window.scheduledTests.filter(test => {
                const matchesSearch = !searchTerm || 
                    (test.testName && test.testName.toLowerCase().includes(searchTerm)) ||
                    (test.section && test.section.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            displayScheduledTests();
        };

        // Filter results table
        window.filterResultsTable = function() {
            const searchTerm = document.getElementById('searchResults').value.toLowerCase();
            const sectionFilter = document.getElementById('filterSection').value;
            const testFilter = document.getElementById('filterTest').value;
            
            window.filteredResults = window.testResults.filter(result => {
                // Search term filter
                const matchesSearch = !searchTerm || 
                    (result.studentName && result.studentName.toLowerCase().includes(searchTerm)) ||
                    (result.studentEmail && result.studentEmail.toLowerCase().includes(searchTerm));
                
                // Section filter
                const matchesSection = !sectionFilter || result.section === sectionFilter;
                
                // Test filter
                const matchesTest = !testFilter || result.testName === testFilter;
                
                return matchesSearch && matchesSection && matchesTest;
            });
            
            displayTestResults();
        };

        // Clear result filters
        window.clearResultFilters = function() {
            document.getElementById('searchResults').value = '';
            document.getElementById('filterSection').value = '';
            document.getElementById('filterTest').value = '';
            
            window.filteredResults = [...window.testResults];
            displayTestResults();
        };

        // Show schedule test modal
        window.showScheduleTestModal = function() {
            const modal = document.getElementById('scheduleTestModal');
            const sectionSelect = document.getElementById('testSection');
            
            // Clear previous options
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            
            // Add assigned sections
            if (window.assignedSections && window.assignedSections.length > 0) {
                const uniqueSections = new Set();
                window.assignedSections.forEach(section => {
                    if (!uniqueSections.has(section.name)) {
                        uniqueSections.add(section.name);
                        const option = document.createElement('option');
                        option.value = section.name;
                        option.textContent = `${section.name} (${section.studentCount} students)`;
                        sectionSelect.appendChild(option);
                    }
                });
            } else {
                const option = document.createElement('option');
                option.value = "no-sections";
                option.textContent = "No sections assigned - Contact Head Admin";
                option.disabled = true;
                sectionSelect.appendChild(option);
            }
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('testDate').value = today;
            
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('testDeadline').value = nextWeek.toISOString().split('T')[0];
            document.getElementById('testDeadlineTime').value = '23:59';
            
            // Add test type change listener
            const testTypeSelect = document.getElementById('testType');
            testTypeSelect.addEventListener('change', handleTestTypeChange);
            
            modal.style.display = 'flex';
        };

        // Handle test type change
        function handleTestTypeChange(event) {
            const testType = event.target.value;
            const targetGroup = document.getElementById('testTargetGroup');
            const targetLabel = document.getElementById('testTargetLabel');
            const targetInput = document.getElementById('testTarget');
            const targetHint = document.getElementById('testTargetHint');
            
            if (!testType) {
                targetGroup.style.display = 'none';
                return;
            }
            
            const normalizedType = testType.toLowerCase();
            
            if (normalizedType.includes('3-minute') || normalizedType.includes('step test')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Duration (minutes)';
                targetInput.placeholder = 'Duration is fixed at 3 minutes';
                targetInput.value = '3';
                targetInput.readOnly = true;
                targetHint.textContent = 'This test has a fixed duration of 3 minutes';
            } else if (normalizedType.includes('curl-up')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Curl-Ups';
                targetInput.placeholder = 'Enter target number of curl-ups';
                targetInput.value = '25';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target number of abdominal curls (one every 3 seconds)';
            } else if (normalizedType.includes('push-up') || normalizedType.includes('pushup')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Push-ups';
                targetInput.placeholder = 'Enter target number of push-ups';
                targetInput.value = '20';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target number of push-ups students should aim to complete';
            } else if (normalizedType.includes('sit-and-reach')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Distance (cm)';
                targetInput.placeholder = 'Enter target distance in cm';
                targetInput.value = '15';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target reach distance in centimeters';
            } else if (normalizedType.includes('skinfold')) {
                targetGroup.style.display = 'block';
                targetLabel.textContent = 'Target Body Fat %';
                targetInput.placeholder = 'Enter target body fat percentage';
                targetInput.value = '15';
                targetInput.readOnly = false;
                targetHint.textContent = 'Set the target body fat percentage (requires trained professional)';
            } else {
                targetGroup.style.display = 'none';
            }
        }

        // Close schedule test modal
        window.closeScheduleTestModal = function() {
            document.getElementById('scheduleTestModal').style.display = 'none';
            document.getElementById('testType').value = '';
            document.getElementById('testSection').value = '';
            document.getElementById('testDate').value = '';
            document.getElementById('testDeadline').value = '';
            document.getElementById('testDeadlineTime').value = '23:59';
            document.getElementById('attemptsAllowed').value = '1';
            document.getElementById('testInstructions').value = '';
            document.getElementById('testTarget').value = '';
            document.getElementById('videoURL').value = '';
            document.getElementById('testTargetGroup').style.display = 'none';
        };

        // Schedule test
        window.scheduleTest = async function() {
            const testType = document.getElementById('testType').value;
            const testSection = document.getElementById('testSection').value;
            const testDate = document.getElementById('testDate').value;
            const testDeadline = document.getElementById('testDeadline').value;
            const testDeadlineTime = document.getElementById('testDeadlineTime').value;
            const attemptsAllowed = document.getElementById('attemptsAllowed').value;
            const testInstructions = document.getElementById('testInstructions').value;
            const testTarget = document.getElementById('testTarget').value;
            const videoURL = document.getElementById('videoURL').value;

            if (!testType || !testSection || !testDate || !testDeadline || !testDeadlineTime) {
                alert('Please fill in all required fields.');
                return;
            }

            if (testSection === "no-sections") {
                alert('You need to be assigned to a section before scheduling tests.');
                return;
            }

            if (videoURL && !videoURL.includes('youtube.com') && !videoURL.includes('youtu.be')) {
                alert('Please provide a valid YouTube URL or leave it empty');
                return;
            }

            try {
                const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Scheduling...';

                const sectionDetails = window.assignedSections.find(s => s.name === testSection);
                const totalStudents = sectionDetails ? sectionDetails.studentCount : 0;

                const deadlineDateTime = new Date(`${testDeadline}T${testDeadlineTime}`);
                const testDateObj = new Date(testDate);
                const now = new Date();
                
                let status = 'scheduled';
                if (testDateObj <= now && deadlineDateTime >= now) {
                    status = 'active';
                } else if (deadlineDateTime < now) {
                    status = 'completed';
                }

                const testData = {
                    testName: testType,
                    section: testSection,
                    date: testDate,
                    deadline: testDeadline,
                    deadlineTime: testDeadlineTime,
                    deadlineDateTime: deadlineDateTime.toISOString(),
                    attemptsAllowed: parseInt(attemptsAllowed),
                    instructions: testInstructions,
                    testTarget: testTarget ? parseInt(testTarget) : null,
                    videoURL: videoURL || null,
                    professorEmail: window.currentUser.email,
                    professorId: window.currentUser.uid,
                    professorName: window.currentUser.displayName || window.currentUser.email,
                    status: status,
                    totalStudents: totalStudents,
                    completedStudents: 0,
                    createdAt: serverTimestamp(),
                    isVisible: true,
                    isActive: true
                };

                await addDoc(collection(db, 'scheduledTests'), testData);
                
                closeScheduleTestModal();
                alert('Test scheduled successfully!');
                
                await loadScheduledTests();
                
            } catch (error) {
                console.error('Error scheduling test:', error);
                alert('Error scheduling test: ' + error.message);
                
                const submitBtn = document.querySelector('#scheduleTestModal .btn-success');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Schedule Test';
            }
        };

        // Edit test
        window.editTest = async function(testId) {
            try {
                const testDoc = await getDoc(doc(db, 'scheduledTests', testId));
                
                if (!testDoc.exists()) {
                    alert('Test not found');
                    return;
                }
                
                const testData = testDoc.data();
                const modal = document.getElementById('editTestModal');
                
                // Populate form fields
                document.getElementById('editTestName').value = testData.testName || '';
                document.getElementById('editTestSection').value = testData.section || '';
                document.getElementById('editTestDate').value = testData.date || '';
                document.getElementById('editTestDeadline').value = testData.deadline || '';
                document.getElementById('editTestDeadlineTime').value = testData.deadlineTime || '23:59';
                document.getElementById('editAttemptsAllowed').value = `${testData.attemptsAllowed || 1} Attempt(s)`;
                document.getElementById('editTestId').value = testId;
                
                // Handle test target
                const targetGroup = document.getElementById('editTestTargetGroup');
                const targetLabel = document.getElementById('editTestTargetLabel');
                const targetInput = document.getElementById('editTestTarget');
                const targetHint = document.getElementById('editTestTargetHint');
                
                const normalized = testData.testName.toLowerCase();
                
                if (normalized.includes('push-up') || normalized.includes('pushup')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Push-ups';
                    targetInput.value = testData.testTarget || 20;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of push-ups';
                } else if (normalized.includes('sit-up') || normalized.includes('situp')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Sit-ups';
                    targetInput.value = testData.testTarget || 30;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of sit-ups';
                } else if (normalized.includes('curl-up')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Curl-Ups';
                    targetInput.value = testData.testTarget || 25;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target number of curl-ups';
                } else if (normalized.includes('plank')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Duration (seconds)';
                    targetInput.value = testData.testTarget || 60;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target plank duration in seconds';
                } else if (normalized.includes('grip')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Grip Strength (kg)';
                    targetInput.value = testData.testTarget || 40;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target grip strength in kg';
                } else if (normalized.includes('sit-and-reach')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Distance (cm)';
                    targetInput.value = testData.testTarget || 15;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target reach distance in cm';
                } else if (normalized.includes('mile') || normalized.includes('run')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Time (minutes)';
                    targetInput.value = testData.testTarget || 8;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target completion time in minutes';
                } else if (normalized.includes('step test') || normalized.includes('3-minute')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Duration (minutes)';
                    targetInput.value = testData.testTarget || 3;
                    targetInput.readOnly = true;
                    targetHint.textContent = 'Fixed duration of 3 minutes';
                } else if (normalized.includes('skinfold')) {
                    targetGroup.style.display = 'block';
                    targetLabel.textContent = 'Target Body Fat %';
                    targetInput.value = testData.testTarget || 15;
                    targetInput.readOnly = false;
                    targetHint.textContent = 'Target body fat percentage';
                } else {
                    targetGroup.style.display = 'none';
                }
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading test:', error);
                alert('Error loading test data: ' + error.message);
            }
        };

        // Close edit test modal
        window.closeEditTestModal = function() {
            document.getElementById('editTestModal').style.display = 'none';
        };

        // Save edited test
        window.saveEditTest = async function() {
            const testId = document.getElementById('editTestId').value;
            const newDate = document.getElementById('editTestDate').value;
            const newDeadline = document.getElementById('editTestDeadline').value;
            const newDeadlineTime = document.getElementById('editTestDeadlineTime').value;
            const newTarget = document.getElementById('editTestTarget').value;
            
            if (!newDate || !newDeadline || !newDeadlineTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const saveBtn = document.querySelector('#editTestModal .btn-success');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                const deadlineObj = new Date(`${newDeadline}T${newDeadlineTime}`);
                const testDateObj = new Date(newDate);
                const now = new Date();
                
                const updateData = {
                    date: newDate,
                    deadline: newDeadline,
                    deadlineTime: newDeadlineTime,
                    deadlineDateTime: deadlineObj.toISOString(),
                    testTarget: newTarget ? parseInt(newTarget) : null,
                    updatedAt: serverTimestamp()
                };
                
                if (testDateObj <= now && deadlineObj >= now) {
                    updateData.status = 'active';
                } else if (deadlineObj < now) {
                    updateData.status = 'completed';
                } else {
                    updateData.status = 'scheduled';
                }
                
                await updateDoc(doc(db, 'scheduledTests', testId), updateData);
                
                closeEditTestModal();
                alert('âœ… Test updated successfully!');
                await loadScheduledTests();
                
            } catch (error) {
                console.error('âŒ Error:', error);
                alert('Error updating test: ' + error.message);
                
                const saveBtn = document.querySelector('#editTestModal .btn-success');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        };

        // Delete test
        window.deleteTest = async function(testId) {
            if (confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'scheduledTests', testId));
                    alert('Test deleted successfully!');
                    await loadScheduledTests();
                } catch (error) {
                    console.error('âŒ Error deleting test:', error);
                    alert('Error deleting test: ' + error.message);
                }
            }
        };

        // View result details
        window.viewResultDetails = async function(resultId) {
            try {
                const resultDoc = await getDoc(doc(db, 'testResults', resultId));
                
                if (!resultDoc.exists()) {
                    alert('Result not found');
                    return;
                }
                
                const result = resultDoc.data();
                const modal = document.getElementById('resultDetailsModal');
                const content = document.getElementById('resultDetailsContent');
                
                const score = result.score || calculateTestScore(result.testName, result.result, result.testTarget);
                const rating = getRating(score);
                const date = result.submittedAt?.toDate ? 
                    result.submittedAt.toDate().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 
                    new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-5 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><i class="fas fa-user"></i> <strong>Student:</strong> ${result.studentName || 'Unknown'}</div>
                                <div><i class="fas fa-chalkboard-teacher"></i> <strong>Section:</strong> ${result.section || 'N/A'}</div>
                                <div><i class="fas fa-calendar-alt"></i> <strong>Date:</strong> ${date}</div>
                                <div><i class="fas fa-running"></i> <strong>Test:</strong> ${result.testName || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">Test Score</div>
                                <div class="text-3xl font-bold" style="color: ${score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444'}">
                                    ${score}%
                                </div>
                                <div class="mt-2">
                                    <span class="rating-badge ${rating.class}">${rating.text}</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">Test Result</div>
                                <div class="text-2xl font-bold">${result.result || 'N/A'}</div>
                                ${result.testTarget ? `<div class="text-sm text-gray-600 mt-1">Target: ${result.testTarget}</div>` : ''}
                            </div>
                        </div>
                        
                        ${result.bmi ? `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">BMI Information</div>
                                <div class="text-lg font-bold">${result.bmi}</div>
                                <div class="text-sm text-gray-600 mt-1">Body Mass Index</div>
                            </div>
                        ` : ''}
                        
                        ${result.timerValue ? `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">Duration</div>
                                <div class="text-lg font-bold">${result.timerValue}</div>
                                <div class="text-sm text-gray-600 mt-1">Time taken to complete the test</div>
                            </div>
                        ` : ''}
                        
                        ${result.attemptNumber ? `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">Attempt Information</div>
                                <div class="text-lg font-bold">Attempt ${result.attemptNumber}</div>
                                <div class="text-sm text-gray-600 mt-1">Out of ${result.attemptsAllowed || 1} allowed attempts</div>
                            </div>
                        ` : ''}
                        
                        ${result.notes ? `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-blue-900 font-medium mb-2">Notes</div>
                                <div class="text-gray-700">${result.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading result details:', error);
                alert('Error loading result details: ' + error.message);
            }
        };

        // Close result details modal
        window.closeResultDetailsModal = function() {
            document.getElementById('resultDetailsModal').style.display = 'none';
        };

        // Generate reports
        window.generateReports = function() {
            alert('Report generation feature will be implemented soon!');
        };

        // Setup real-time updates
        function setupRealTimeUpdates() {
            try {
                if (!window.currentUser) return;
                
                // Listen for test changes
                const testsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('professorEmail', '==', window.currentUser.email)
                );
                
                onSnapshot(testsQuery, (snapshot) => {
                    console.log('ðŸ”„ Real-time update triggered for tests');
                    loadScheduledTests();
                });
                
                // Listen for result changes
                const resultsQuery = query(
                    collection(db, 'testResults'),
                    orderBy('submittedAt', 'desc'),
                    limit(100)
                );
                
                onSnapshot(resultsQuery, (snapshot) => {
                    console.log('ðŸ”„ Real-time update triggered for results');
                    loadTestResults();
                });
                
            } catch (error) {
                console.error('Error setting up real-time updates:', error);
            }
        }

        // Helper functions
        function calculateTestScore(testName, result, testTarget = null) {
            const normalized = testName.toLowerCase();
            
            let numericValue = 0;
            
            if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) {
                    numericValue = parseFloat(match[1]);
                } else {
                    numericValue = parseFloat(result) || 0;
                }
            } else {
                numericValue = parseFloat(result) || 0;
            }
            
            // Simple scoring logic
            if (testTarget && testTarget > 0) {
                const percentage = (numericValue / testTarget) * 100;
                let score = Math.min(100, Math.max(50, percentage));
                
                if (percentage >= 100) score = 100;
                else if (percentage >= 90) score = 95;
                else if (percentage >= 80) score = 90;
                else if (percentage >= 70) score = 85;
                else if (percentage >= 60) score = 80;
                else if (percentage >= 50) score = 75;
                
                return Math.round(score);
            }
            
            return 75; // Default score
        }

        function getRating(score) {
            if (score >= 90) return { text: 'Excellent', class: 'rating-excellent' };
            if (score >= 80) return { text: 'Good', class: 'rating-good' };
            if (score >= 70) return { text: 'Fair', class: 'rating-fair' };
            return { text: 'Needs Improvement', class: 'rating-fair' };
        }
    </script>
</body>
</html>