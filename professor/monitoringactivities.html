<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Real-time Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            -webkit-font-smoothing: antialiased; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif; 
        }
        body { 
            margin: 0; 
            padding: 0; 
            background-color: #f6f6f6;
            overflow-x: hidden;
            width: 100%;
        }
        
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.1); }
            100% { background-color: transparent; }
        }
        
        /* Hamburger Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            z-index: 60;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Mobile Drawer */
        .mobile-drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            height: 100vh;
            background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);
            z-index: 55;
            transition: right 0.3s ease;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-drawer.active { right: 0; }
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .drawer-overlay.active { opacity: 1; visibility: visible; }

        @media (max-width: 768px) {
            .hamburger { display: flex; }
            .desktop-nav { display: none; }
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom styles */
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        
        /* Tab Navigation - FIXED */
        .tab-nav {
            display: flex;
            gap: 2px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab-nav::-webkit-scrollbar {
            height: 4px;
        }
        .tab-nav::-webkit-scrollbar-track {
            background: transparent;
        }
        .tab-nav::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            outline: none;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.5);
            color: #475569;
            transform: translateY(-1px);
        }
        .tab-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        .tab-badge {
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .tab-badge.tests {
            background: #f59e0b;
        }
        .tab-badge.activity {
            background: #8b5cf6;
        }
        
        /* Sort Controls - UPDATED: 3 separate combo boxes */
        .sort-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            background: #f8fafc;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .sort-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            min-width: 160px;
        }
        
        .sort-group i {
            color: #64748b;
            font-size: 14px;
        }
        
        .sort-select {
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
            cursor: pointer;
            outline: none;
            flex: 1;
        }
        
        .sort-order-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
            margin-left: 5px;
        }
        
        .sort-order-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        .activity-timeline::-webkit-scrollbar {
            width: 6px;
        }
        .activity-timeline::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .activity-timeline::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }
        .activity-item:hover {
            background-color: #f8fafc;
            transform: translateX(2px);
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-item.new-activity {
            animation: highlight 2s ease;
            border-left: 4px solid #3b82f6;
        }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            color: white;
            font-size: 14px;
        }
        .activity-icon.professor { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .activity-icon.student { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .activity-icon.test { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .activity-icon.system { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .activity-content {
            flex: 1;
        }
        .activity-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .activity-details {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .activity-time {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .activity-time .live-indicator {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Empty State */
        .empty-state { 
            padding: 60px 40px; 
            text-align: center; 
        }
        .empty-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
            opacity: 0.4; 
        }
        .empty-title { 
            font-weight: 700; 
            color: #1f2937; 
            font-size: 20px; 
            margin-bottom: 12px; 
        }
        .empty-text { 
            font-weight: 400; 
            color: #64748b; 
            font-size: 14px; 
            line-height: 1.6; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .activity-count-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
            vertical-align: middle;
        }
        
        /* Real-time indicator */
        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        /* Stat card styles */
        .stat-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        /* Live activity indicator */
        .live-activity-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        /* Notification toast */
        .notification-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 350px;
        }
        .notification-toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .notification-message {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }
        
        /* Test cards */
        .test-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border-color: #3b82f6;
        }
        
        .test-section-badge {
            background: #e2e8f0;
            color: #475569;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Test Detail Modal - ENHANCED */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #e2e8f0;
            transform: rotate(90deg);
        }
        
        /* Student Filter Controls in Modal */
        .modal-filter-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
            min-width: 200px;
        }
        
        .filter-group i {
            color: #3b82f6;
            font-size: 14px;
        }
        
        .filter-select {
            border: none;
            background: transparent;
            padding: 5px 0;
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
            cursor: pointer;
            outline: none;
            flex: 1;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            font-size: 13px;
            outline: none;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 14px;
        }
        
        .student-stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item .taken {
            color: #10b981;
            font-weight: 700;
        }
        
        .stat-item .not-taken {
            color: #ef4444;
            font-weight: 700;
        }
        
        .modal-section-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .section-tab {
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #64748b;
        }
        
        .section-tab.active {
            background: #3b82f6;
            color: white;
        }
        
        .student-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .student-list-item:hover {
            background: #f1f5f9;
            transform: translateX(2px);
            border-color: #3b82f6;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .student-details {
            flex: 1;
        }
        
        .student-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .student-email {
            font-size: 12px;
            color: #64748b;
        }
        
        .student-status-badge {
            padding: 6px 15px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .student-status-badge.taken {
            background: #d1fae5;
            color: #065f46;
        }
        
        .student-status-badge.not-taken {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .student-score {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .score-excellent {
            background: #d1fae5;
            color: #065f46;
        }
        
        .score-good {
            background: #fef3c7;
            color: #92400e;
        }
        
        .score-average {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .score-poor {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .view-details-btn {
            padding: 6px 12px;
            border-radius: 20px;
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-details-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .tab-btn {
                min-width: 100px;
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .sort-container {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
            }
            
            .sort-group {
                width: 100%;
            }
            
            .modal-filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group, .search-box, .student-stats {
                width: 100%;
            }
            
            .student-stats {
                margin-left: 0;
                justify-content: space-between;
            }
            
            .student-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .student-score {
                width: 100%;
                justify-content: space-between;
            }
            
            .stat-card {
                padding: 16px !important;
            }
            
            .stat-card .font-extrabold {
                font-size: 24px !important;
            }
            
            .notification-toast {
                left: 20px;
                right: 20px;
                max-width: none;
            }
            
            .modal-container {
                width: 95%;
                padding: 16px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 overflow-x-hidden">
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading Real-time Monitoring Dashboard...</div>
        <div class="mt-2 text-sm text-gray-500">Connecting to live data streams...</div>
    </div>
    
    <div id="mainContent" class="hidden overflow-x-hidden">
        <!-- âœ… UPDATED NAVIGATION BANNER - MATCHING LANDING PAGE DESIGN -->
        <header class="shadow-lg fixed w-full top-0 z-50" style="background: linear-gradient(135deg, #0D1B2A 0%, #1A2B3C 50%, #2C4A5E 100%);">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo -->
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-16 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-20 h-20 object-contain">
                        </div>
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div class="desktop-nav hidden md:flex items-center gap-8">
                        <a href="professor.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-users mr-2"></i>Students
                        </a>
                        <a href="addactivities.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-dumbbell mr-2"></i>Activities
                        </a>
                        <a href="addlesson.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-book-open mr-2"></i>Lessons
                        </a>
                        <a href="monitoringactivities.html" class="text-white font-medium px-3 py-2 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-chart-bar mr-2"></i>Monitoring
                        </a>
                        <a href="grades.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-graduation-cap mr-2"></i>Grades
                        </a>
                        <a href="sectionranklist.html" class="text-white/80 hover:text-white font-medium transition-colors">
                            <i class="fas fa-trophy mr-2"></i>Section Rank
                        </a>
                    </div>

                    <!-- Desktop Profile -->
                    <div class="hidden md:block relative">
                        <img src="" alt="Profile" id="profilePictureBtn"
                             class="w-10 h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                        
                        <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                            <div class="p-6 border-b-2 border-gray-200 text-center">
                                <img src="" alt="Profile" id="profileDropdownPicture" class="w-20 h-20 rounded-full mx-auto mb-3 border-3 border-blue-500 object-cover">
                                <h6 id="profileDropdownName" class="font-bold text-gray-900 text-lg">Loading...</h6>
                                <p id="profileDropdownEmail" class="text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                            </div>
                            <div class="p-2">
                                <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                    <i class="bi bi-person-circle text-blue-500 text-xl"></i>
                                    <span class="font-medium text-gray-700 text-base">View Profile</span>
                                </a>
                                <div class="h-px bg-gray-200 my-2"></div>
                                <div onclick="handleLogout(event)" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                    <i class="fas fa-sign-out-alt text-xl"></i>
                                    <span class="font-medium text-base">Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Right Icons -->
                    <div class="flex md:hidden items-center gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="professor-profile.html" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hamburger Menu -->
                        <div class="hamburger" id="hamburger">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Mobile Drawer Overlay -->
            <div class="drawer-overlay" id="drawerOverlay"></div>

            <!-- Mobile Drawer -->
            <div class="mobile-drawer" id="mobileDrawer">
                <div class="p-6 pt-8">
                    <!-- Drawer Header -->
                    <div class="flex items-center gap-3 mb-8 pb-6 border-b border-white/20">
                        <div class="w-12 h-12 flex items-center justify-center overflow-visible">
                            <img src="UMakfit Logo (2).png" alt="UMakFIT Logo" class="w-14 h-14 object-contain">
                        </div>
                        <span class="text-2xl font-extrabold font-montserrat gradient-text">
                            UMakFIT
                        </span>
                    </div>

                    <!-- Navigation Links -->
                    <nav class="space-y-2 mb-8">
                        <a href="professor.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                        </a>
                        <a href="studentmanagement.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-users mr-3"></i>Student Management
                        </a>
                        <a href="addactivities.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-dumbbell mr-3"></i>Add Activities
                        </a>
                        <a href="addlesson.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-book-open mr-3"></i>Add Lesson
                        </a>
                        <a href="monitoringactivities.html" class="mobile-nav-link block text-white font-medium py-3 px-4 rounded-lg" style="background: linear-gradient(135deg, #EAD38A 0%, #C5A046 50%, #8B6D2D 100%);">
                            <i class="fas fa-chart-bar mr-3"></i>Monitoring Activities
                        </a>
                        <a href="grades.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-graduation-cap mr-3"></i>Grades
                        </a>
                        <a href="sectionranklist.html" class="mobile-nav-link block text-white/80 hover:text-white font-medium py-3 px-4 rounded-lg hover:bg-white/10 transition-all">
                            <i class="fas fa-trophy mr-3"></i>Section Rank List
                        </a>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content - with top padding to account for fixed header -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-32 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div class="flex items-center">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center mr-4">
                                <i class="fas fa-desktop text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-blue-900 font-bold text-2xl md:text-3xl">Real-time Monitoring Dashboard</h1>
                                <p class="text-gray-600 font-medium text-base mt-2">Live tracking of student activity and test completion</p>
                                <div class="flex items-center gap-2 mt-3">
                                    <div class="real-time-indicator">
                                        <span class="live-indicator"></span>
                                        <span>LIVE</span>
                                    </div>
                                    <span class="text-sm text-gray-500" id="lastUpdateTime">Updating now...</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button class="bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 text-blue-900 font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="refreshAllData()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Refresh Now</span>
                            </button>
                            <button class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="showSettings()">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-nav mb-6" id="tabNavigation">
                    <button class="tab-btn active" data-tab="overview" id="overviewTabBtn">
                        <i class="fas fa-chart-bar"></i> <span class="hidden sm:inline">Overview</span>
                        <span class="tab-badge" id="overviewBadge"></span>
                    </button>
                    <button class="tab-btn" data-tab="tests" id="testsTabBtn">
                        <i class="fas fa-clipboard-check"></i> <span class="hidden sm:inline">All Tests</span>
                        <span class="tab-badge tests" id="testsBadge">0</span>
                    </button>
                    <button class="tab-btn" data-tab="activity" id="activityTabBtn">
                        <i class="fas fa-history"></i> <span class="hidden sm:inline">Activity Feed</span>
                        <span class="tab-badge activity" id="activityBadge">0</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="tabContent">
                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content active">
                        <!-- Quick Stats Overview -->
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-chart-line"></i>
                                    Live Statistics
                                </h3>
                                <div class="flex items-center space-x-2 bg-blue-50 text-blue-700 font-semibold text-sm py-1.5 px-4 rounded-full border border-blue-200">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full live-dot"></div>
                                    <span>Real-time Updates</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                                <!-- Total Students -->
                                <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-user-graduate"></i>
                                            <span class="font-semibold text-sm">Total Students</span>
                                        </div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="totalStudentsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Across all sections</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="studentsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Active Tests -->
                                <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-running"></i>
                                            <span class="font-semibold text-sm">Active Tests</span>
                                        </div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="activeTestsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Currently in progress</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="activeTestsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Tests Completed Today -->
                                <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-clipboard-check"></i>
                                            <span class="font-semibold text-sm">Tests Today</span>
                                        </div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="totalTestsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Completed in last 24h</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="testsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Total Sections -->
                                <div class="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl text-white p-6">
                                    <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-users"></i>
                                            <span class="font-semibold text-sm">Sections</span>
                                        </div>
                                    </div>
                                    <div class="font-extrabold text-3xl" id="totalSectionsCount">0</div>
                                    <div class="text-sm opacity-90 mt-4">Active sections</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="sectionsProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Section Performance -->
                            <div class="mt-6">
                                <h4 class="text-gray-900 font-bold text-lg mb-4 flex items-center gap-2">
                                    <i class="fas fa-chart-pie"></i>
                                    Section Performance
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sectionPerformance">
                                    <!-- Sections will be dynamically added here -->
                                    <div class="text-center py-4 text-gray-500">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <div class="mt-2">Loading section data...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- All Tests Tab -->
                    <div id="testsTab" class="tab-content">
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-clipboard-list"></i>
                                    All Tests & Assessments
                                </h3>
                                <div class="flex flex-wrap items-center gap-3 mt-2 sm:mt-0">
                                    <!-- Sorting Controls - THREE SEPARATE COMBO BOXES -->
                                    <div class="sort-container">
                                        <!-- Sort by Section -->
                                        <div class="sort-group">
                                            <i class="fas fa-chalkboard-teacher"></i>
                                            <select id="sortBySection" class="sort-select" onchange="applyTestSort()">
                                                <option value="">All Sections</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Sort by Test Name -->
                                        <div class="sort-group">
                                            <i class="fas fa-font"></i>
                                            <select id="sortByName" class="sort-select" onchange="applyTestSort()">
                                                <option value="">All Test Names</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Sort by Date -->
                                        <div class="sort-group">
                                            <i class="fas fa-calendar-alt"></i>
                                            <select id="sortByDate" class="sort-select" onchange="applyTestSort()">
                                                <option value="">All Dates</option>
                                                <option value="newest">Newest First</option>
                                                <option value="oldest">Oldest First</option>
                                            </select>
                                        </div>
                                        
                                        <button class="sort-order-btn" onclick="resetSortFilters()" title="Reset Filters">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <button class="bg-gradient-to-r from-blue-400 to-blue-500 hover:from-blue-500 hover:to-blue-600 text-white font-semibold text-sm py-2 px-4 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5" onclick="refreshAllTests()">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Refresh</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="allTestsList">
                                <div class="text-center py-10 col-span-full">
                                    <div class="text-4xl text-gray-300 mb-4">
                                        <i class="fas fa-running"></i>
                                    </div>
                                    <div class="text-gray-500 font-medium">Loading tests...</div>
                                    <div class="text-sm text-gray-400 mt-2">Please wait while we load all tests</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Feed Tab -->
                    <div id="activityTab" class="tab-content">
                        <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                                <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                                    <i class="fas fa-bell"></i>
                                    Live Activity Feed
                                    <span class="text-sm font-normal text-gray-500 ml-2" id="activityUpdateTime">Streaming live...</span>
                                </h3>
                                <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                                    <div class="flex items-center space-x-2">
                                        <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="activityTypeFilter" onchange="filterActivities()">
                                            <option value="all">All Activities</option>
                                            <option value="test">Test Completions</option>
                                            <option value="student">Student Activities</option>
                                            <option value="system">System Events</option>
                                        </select>
                                    </div>
                                    <button class="bg-gradient-to-r from-red-400 to-red-500 hover:from-red-500 hover:to-red-600 text-white font-semibold text-sm py-1.5 px-3 rounded-lg flex items-center gap-2 transition-all hover:-translate-y-0.5" onclick="clearActivityFeed()">
                                        <i class="fas fa-trash"></i>
                                        <span>Clear</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="activity-timeline" id="activityTimeline">
                                <div class="text-center py-10">
                                    <div class="text-4xl text-gray-300 mb-4">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <div class="text-gray-500 font-medium">No activities yet</div>
                                    <div class="text-sm text-gray-400 mt-2">Activity feed will populate as students interact with the system</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ENHANCED Test Detail Modal with Student Filtering -->
        <div id="testDetailModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <div>
                        <h2 id="modalTestTitle" class="text-xl font-bold text-gray-900">Test Name</h2>
                        <p id="modalTestSection" class="text-sm text-gray-500 mt-1">Section: Loading...</p>
                    </div>
                    <div class="modal-close" onclick="closeTestModal()">
                        <i class="fas fa-times text-gray-600"></i>
                    </div>
                </div>
                
                <!-- Section Tabs -->
                <div class="modal-section-selector" id="modalSectionTabs">
                    <!-- Sections will be dynamically added here -->
                </div>
                
                <!-- Test Summary -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <span class="text-xs text-gray-500">Total Students</span>
                            <div class="font-bold text-xl" id="modalTotalStudents">0</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Completed</span>
                            <div class="font-bold text-xl text-green-600" id="modalCompletedCount">0</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Not Taken</span>
                            <div class="font-bold text-xl text-red-600" id="modalNotTakenCount">0</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Completion Rate</span>
                            <div class="font-bold text-xl" id="modalCompletionRate">0%</div>
                        </div>
                    </div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill" id="modalProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Student Filter Controls -->
                <div class="modal-filter-container">
                    <!-- Filter by Status -->
                    <div class="filter-group">
                        <i class="fas fa-filter"></i>
                        <select id="studentStatusFilter" class="filter-select" onchange="filterModalStudents()">
                            <option value="all">All Students</option>
                            <option value="taken">Taken</option>
                            <option value="not-taken">Not Taken</option>
                        </select>
                    </div>
                    
                    <!-- Sort by -->
                    <div class="filter-group">
                        <i class="fas fa-sort-alpha-down"></i>
                        <select id="studentSortBy" class="filter-select" onchange="filterModalStudents()">
                            <option value="name">Sort by Name</option>
                            <option value="email">Sort by Email</option>
                            <option value="score">Sort by Score</option>
                        </select>
                    </div>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="studentSearch" placeholder="Search students..." onkeyup="filterModalStudents()">
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="student-stats">
                        <div class="stat-item">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span><span class="taken" id="takenCount">0</span> Taken</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-times-circle text-red-500"></i>
                            <span><span class="not-taken" id="notTakenCount">0</span> Not Taken</span>
                        </div>
                    </div>
                </div>
                
                <!-- Student List Title with Count -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-900" id="modalListTitle">Students in this section</h3>
                    <span class="text-sm text-gray-500" id="displayedCount">Showing 0 of 0 students</span>
                </div>
                
                <!-- Student List -->
                <div id="modalStudentList" class="max-h-96 overflow-y-auto space-y-2">
                    <!-- Students will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Student Test Details Modal (for individual student results) -->
        <div id="studentDetailsModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 700px;">
                <div class="modal-header">
                    <div>
                        <h2 id="studentDetailsName" class="text-xl font-bold text-gray-900">Student Name</h2>
                        <p id="studentDetailsEmail" class="text-sm text-gray-500 mt-1">student@umak.edu.ph</p>
                    </div>
                    <div class="modal-close" onclick="closeStudentDetailsModal()">
                        <i class="fas fa-times text-gray-600"></i>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-xl mb-6">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <span class="text-xs text-gray-500">Test Name</span>
                            <div class="font-bold" id="studentDetailsTest">Test Name</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Score</span>
                            <div class="font-bold text-green-600" id="studentDetailsScore">0%</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500">Status</span>
                            <div class="font-bold" id="studentDetailsStatus">Taken</div>
                        </div>
                    </div>
                </div>
                
                <div id="studentTestAttempts" class="space-y-3">
                    <!-- Test attempts will be shown here -->
                </div>
                
                <div class="modal-footer mt-4">
                    <button class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors" onclick="closeStudentDetailsModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- âœ… UPDATED FOOTER - MATCHING LANDING PAGE DESIGN -->
        <footer class="bg-gradient-to-r from-blue-900 to-blue-800 text-white py-8 sm:py-12">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12 text-center lg:text-left">
                    <!-- About UmakFit & College of Human Kinetics -->
                    <div>
                        <div class="flex items-center justify-center lg:justify-start gap-3 mb-4">
                            <img src="UMakfit Logo (2).png" 
                                 alt="UMak Logo" class="h-12 w-auto object-contain">
                            <div>
                                <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-1">UMakFit</h6>
                                <p class="text-xs lg:text-sm text-blue-200 font-medium">College of Human Kinetics</p>
                            </div>
                        </div>
                        <p class="text-sm lg:text-base leading-relaxed text-blue-100">
                            UMakFit is the official fitness assessment and tracking platform of the College of Human Kinetics at University of Makati. 
                            Our mission is to promote health, wellness, and physical fitness through comprehensive assessment and personalized tracking.
                        </p>
                        <div class="mt-4 flex flex-wrap gap-2 justify-center lg:justify-start">
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Fitness Tracking</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Performance Assessment</span>
                            <span class="bg-blue-700/50 px-3 py-1 rounded-full text-xs font-semibold">Health & Wellness</span>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Quick Links</h6>
                        <div class="grid grid-cols-2 gap-4 lg:gap-6">
                            <div class="space-y-3">
                                <a href="professor.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-tachometer mr-2"></i>Dashboard
                                </a>
                                <a href="studentmanagement.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-people mr-2"></i>Students
                                </a>
                                <a href="addactivities.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-dumbbell mr-2"></i>Activities
                                </a>
                            </div>
                            <div class="space-y-3">
                                <a href="addlesson.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-book mr-2"></i>Lessons
                                </a>
                                <a href="monitoringactivities.html" class="block text-yellow-300 hover:text-yellow-200 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base font-semibold">
                                    <i class="bi bi-graph-up mr-2"></i>Monitoring
                                </a>
                                <a href="grades.html" class="block text-blue-100 hover:text-yellow-300 hover:translate-x-1 transition-all duration-200 text-sm lg:text-base">
                                    <i class="bi bi-mortarboard mr-2"></i>Grades
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Social -->
                    <div>
                        <h6 class="text-yellow-400 font-bold text-lg lg:text-xl mb-4 lg:mb-6">Get In Touch</h6>
                        <div class="space-y-4 lg:space-y-5">
                            <div class="flex items-start gap-3">
                                <i class="bi bi-geo-alt-fill text-yellow-400 text-lg lg:text-xl mt-1"></i>
                                <p class="text-sm lg:text-base text-blue-100">
                                    College of Human Kinetics<br>
                                    University of Makati<br>
                                   3rd floor, Administration Building, University of Makati, 
                                   JP Rizal Ext., West Rembo, Taguig City
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-envelope-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <a href="mailto:chk@umak.edu.ph" class="text-blue-100 hover:text-yellow-300 transition-colors text-sm lg:text-base">
                                    chk@umak.edu.ph
                                </a>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="bi bi-telephone-fill text-yellow-400 text-lg lg:text-xl"></i>
                                <span class="text-blue-100 text-sm lg:text-base">+63 933 189 7230</span>
                            </div>
                            <div class="flex items-center gap-4 pt-3 justify-center lg:justify-start">
                                <a href="https://www.facebook.com/profile.php?id=61577064971920" target="_blank" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-facebook text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-twitter text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-instagram text-white text-lg lg:text-xl"></i>
                                </a>
                                <a href="#" class="bg-blue-700 hover:bg-blue-600 p-2.5 rounded-lg transition-all duration-200 hover:scale-110">
                                    <i class="bi bi-youtube text-white text-lg lg:text-xl"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="border-t border-blue-600/50 mt-8 lg:mt-12 pt-6 lg:pt-8">
                    <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                        <!-- Copyright -->
                        <div class="text-center lg:text-left">
                            <p class="text-xs lg:text-sm text-blue-200">
                                Â© 2025 University of Makati - College of Human Kinetics. All Rights Reserved.
                            </p>
                        </div>
                        
                        <!-- University Links -->
                        <div class="flex flex-wrap justify-center gap-3 lg:gap-4">
                            <a href="https://umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                University of Makati
                            </a>
                            <span class="text-blue-400">â€¢</span>
                            <a href="https://library.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                UMak Online Library
                            </a>
                            <span class="text-blue-400">â€¢</span>
                            <a href="https://tbl.umak.edu.ph" target="_blank" class="text-xs lg:text-sm text-blue-200 hover:text-yellow-300 transition-colors">
                                TBL Hub
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification-toast">
        <div class="notification-icon" id="toastIcon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="toastTitle">New Activity</div>
            <div class="notification-message" id="toastMessage">Loading...</div>
        </div>
        <button class="text-gray-400 hover:text-gray-600" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, limit, onSnapshot, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, onValue, set, serverTimestamp as rtdbServerTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175",
            databaseURL: "https://umakfit-e3b1d-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let allActivities = [];
        let assignedSections = [];
        let allStudents = [];
        let onlineStudents = new Map();
        let activeListeners = [];
        let realtimeUpdateInterval;
        let lastUpdateTime = new Date();
        let activityFeed = [];
        const MAX_ACTIVITIES = 50;
        
        // Test sorting variables
        let selectedSection = '';
        let selectedTestName = '';
        let selectedDateOrder = '';
        
        // Store all tests
        let allTests = [];
        let testCompletions = new Map(); // Map of testId -> Set of student emails who completed
        let studentTestResults = new Map(); // Map of studentEmail -> Map of testId -> { attempts: [], bestScore: number }

        // Modal state variables
        let currentTestData = null;
        let currentSelectedSection = null;
        let currentModalStudents = [];
        let currentFilteredStudents = [];

        // DOM Elements
        const hamburger = document.getElementById('hamburger');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');
        const notificationToast = document.getElementById('notificationToast');
        
        // Modal elements
        const testModal = document.getElementById('testDetailModal');
        const studentDetailsModal = document.getElementById('studentDetailsModal');

        // ===================== TAB FUNCTIONS =====================
        
        // Tab switching function - EXPOSED TO GLOBAL SCOPE
        window.switchTab = function(tabName) {
            console.log(`Switching to tab: ${tabName}`);
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked tab button
            const activeTabBtn = document.getElementById(`${tabName}TabBtn`);
            if (activeTabBtn) {
                activeTabBtn.classList.add('active');
            }
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const activeTabContent = document.getElementById(`${tabName}Tab`);
            if (activeTabContent) {
                activeTabContent.classList.add('active');
            }
            
            // Refresh data for active tab
            switch(tabName) {
                case 'overview':
                    refreshOverviewData();
                    break;
                case 'tests':
                    populateSortFilters();
                    displayAllTests();
                    break;
                case 'activity':
                    displayActivityFeed();
                    break;
            }
            
            // Update URL hash for bookmarking
            window.history.replaceState(null, null, `#${tabName}`);
        };

        // Function to update badge counts
        function updateTabBadges() {
            // Update tests badge
            const testsBadge = document.getElementById('testsBadge');
            if (testsBadge) {
                testsBadge.textContent = allTests.length;
                testsBadge.style.display = allTests.length > 0 ? 'inline-flex' : 'none';
            }
            
            // Update activity badge
            const activityBadge = document.getElementById('activityBadge');
            if (activityBadge) {
                const recentActivities = activityFeed.filter(act => 
                    new Date() - act.time < 300000 // Last 5 minutes
                ).length;
                activityBadge.textContent = recentActivities;
                activityBadge.style.display = recentActivities > 0 ? 'inline-flex' : 'none';
            }
            
            // Update overview badge
            const overviewBadge = document.getElementById('overviewBadge');
            if (overviewBadge) {
                const activeTests = document.getElementById('activeTestsCount')?.textContent || '0';
                if (parseInt(activeTests) > 0) {
                    overviewBadge.textContent = activeTests;
                    overviewBadge.style.display = 'inline-flex';
                } else {
                    overviewBadge.style.display = 'none';
                }
            }
        }

        // ===================== END TAB FUNCTIONS =====================

        // Hamburger Menu Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (hamburger && mobileDrawer && drawerOverlay) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    mobileDrawer.classList.toggle('active');
                    drawerOverlay.classList.toggle('active');
                    document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
                });

                drawerOverlay.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    mobileDrawer.classList.remove('active');
                    drawerOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                });

                mobileNavLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        mobileDrawer.classList.remove('active');
                        drawerOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                });
            }
            
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            document.addEventListener('click', closeAllDropdowns);
            
            // Add click listeners to tab buttons using data-tab attribute
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        window.switchTab(tabName);
                    }
                });
            });
            
            // Initialize tabs
            const hash = window.location.hash.replace('#', '');
            if (hash && ['overview', 'tests', 'activity'].includes(hash)) {
                window.switchTab(hash);
            }
            
            // Close modal when clicking outside
            testModal.addEventListener('click', (e) => {
                if (e.target === testModal) {
                    closeTestModal();
                }
            });
            
            studentDetailsModal.addEventListener('click', (e) => {
                if (e.target === studentDetailsModal) {
                    closeStudentDetailsModal();
                }
            });
        });

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 768;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            dropdown.classList.toggle('hidden');
        }

        function closeProfileDropdown() {
            if (profileDropdown) profileDropdown.classList.add('hidden');
            if (profileDropdownMobile) profileDropdownMobile.classList.add('hidden');
        }

        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }
        
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = window.currentUser?.name || window.currentUser?.displayName || userName || 'Professor';
            const email = window.currentUser?.email || 'professor@umak.edu.ph';
            
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Update time display
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timeElement = document.getElementById('lastUpdateTime');
            if (timeElement) {
                timeElement.textContent = `Last updated: ${timeString}`;
            }
            lastUpdateTime = now;
        }

        // Show notification
        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('notificationToast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Set notification type colors
            const colors = {
                info: { bg: '#3b82f6', icon: 'fa-bell' },
                success: { bg: '#10b981', icon: 'fa-check-circle' },
                warning: { bg: '#f59e0b', icon: 'fa-exclamation-triangle' },
                error: { bg: '#ef4444', icon: 'fa-exclamation-circle' },
                test: { bg: '#8b5cf6', icon: 'fa-clipboard-check' },
                student: { bg: '#10b981', icon: 'fa-user-graduate' }
            };
            
            const config = colors[type] || colors.info;
            toastIcon.style.background = config.bg;
            toastIcon.innerHTML = `<i class="fas ${config.icon}"></i>`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Show toast
            toast.classList.add('show');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        window.hideNotification = function() {
            notificationToast.classList.remove('show');
        };

        // Format time relative to now
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Load professor's assigned sections
        async function loadAssignedSections(professorId, professorEmail) {
            try {
                assignedSections = [];
                console.log('Loading sections for professor:', professorEmail);
                
                let professorFullName = null;
                
                // Try professors collection
                const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
                const profSnap = await getDocs(profQuery);
                if (!profSnap.empty) {
                    professorFullName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
                }
                
                // Try users collection
                if (!professorFullName) {
                    const userQuery = query(collection(db, 'users'), where('email', '==', professorEmail));
                    const userSnap = await getDocs(userQuery);
                    if (!userSnap.empty) {
                        professorFullName = userSnap.docs[0].data().fullName || userSnap.docs[0].data().name;
                    }
                }
                
                if (!professorFullName && currentUser) {
                    professorFullName = currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
                }
                
                // Load all sections
                const sectionsSnapshot = await getDocs(collection(db, 'sections'));
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    const dbProfessor = (sectionData.professor || '').toString().trim();
                    
                    const matches = 
                        dbProfessor === professorFullName ||
                        sectionData.professorEmail === professorEmail ||
                        sectionData.professorId === professorId ||
                        dbProfessor.toUpperCase().includes(professorFullName?.toUpperCase() || '') ||
                        (professorFullName && professorFullName.toUpperCase().includes(dbProfessor.toUpperCase()));
                    
                    if (matches) {
                        assignedSections.push({
                            id: doc.id,
                            name: sectionData.name,
                            professorEmail: professorEmail,
                            students: sectionData.students || [],
                            courseCode: sectionData.courseCode,
                            ...sectionData
                        });
                    }
                });
                
                console.log('âœ… Total sections loaded:', assignedSections.length);
                
                // Update sections count
                const totalSectionsElement = document.getElementById('totalSectionsCount');
                if (totalSectionsElement) {
                    totalSectionsElement.textContent = assignedSections.length;
                }
                
                // Update sections progress
                const sectionsProgress = document.getElementById('sectionsProgress');
                if (sectionsProgress) {
                    const progress = Math.min(100, (assignedSections.length / 10) * 100);
                    sectionsProgress.style.width = `${progress}%`;
                }
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

        // Load all students
        async function loadAllStudents() {
            try {
                allStudents = [];
                const studentIds = new Set();
                
                console.log('Loading students from sections:', assignedSections.map(s => s.name));
                
                for (const section of assignedSections) {
                    if (section.students && Array.isArray(section.students)) {
                        section.students.forEach(student => {
                            const uniqueId = student.email || student.student_id || student.studentId;
                            if (uniqueId && !studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: uniqueId,
                                    email: student.email,
                                    name: student.name,
                                    umakId: student.student_id || student.studentId,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                    }
                    
                    try {
                        const studentsQuery = query(
                            collection(db, 'students'),
                            where('section', '==', section.name)
                        );
                        const studentsSnapshot = await getDocs(studentsQuery);
                        
                        studentsSnapshot.forEach((doc) => {
                            const studentData = doc.data();
                            const uniqueId = studentData.email || studentData.umakId || doc.id;
                            
                            if (!studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: doc.id,
                                    ...studentData,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                    } catch (error) {
                        console.log(`No students collection data for section ${section.name}`);
                    }
                }
                
                console.log('âœ… Total unique students loaded:', allStudents.length);
                
                // Update total students count
                const totalStudentsElement = document.getElementById('totalStudentsCount');
                if (totalStudentsElement) totalStudentsElement.textContent = allStudents.length;
                
                // Calculate progress
                const progress = Math.min(100, (allStudents.length / 100) * 100);
                const progressElement = document.getElementById('studentsProgress');
                if (progressElement) progressElement.style.width = `${progress}%`;
                
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load all tests
        async function loadAllTests() {
            try {
                allTests = [];
                
                // Get tests from scheduledTests collection
                const scheduledTestsQuery = query(
                    collection(db, 'scheduledTests')
                );
                
                const scheduledTestsSnapshot = await getDocs(scheduledTestsQuery);
                
                scheduledTestsSnapshot.forEach((docSnap) => {
                    const testData = docSnap.data();
                    const testDate = new Date(testData.date);
                    const now = new Date();
                    
                    // Check if this test belongs to professor's sections
                    const isRelevant = assignedSections.some(section => 
                        section.name === testData.section
                    ) || testData.professorEmail === currentUser?.email;
                    
                    if (isRelevant) {
                        const status = testDate <= now && 
                                      new Date(testData.deadlineDateTime) >= now ? 'active' : 'completed';
                        
                        allTests.push({
                            id: docSnap.id,
                            name: testData.testName || testData.name || 'Unnamed Test',
                            section: testData.section || 'No Section',
                            date: testData.date,
                            deadlineDateTime: testData.deadlineDateTime,
                            status: status,
                            ...testData
                        });
                    }
                });
                
                // Also get tests from activities collection
                try {
                    const activitiesQuery = query(
                        collection(db, 'activities')
                    );
                    
                    const activitiesSnapshot = await getDocs(activitiesQuery);
                    
                    activitiesSnapshot.forEach((docSnap) => {
                        const activityData = docSnap.data();
                        
                        // Check if relevant
                        const isRelevant = assignedSections.some(section => 
                            section.name === activityData.section
                        ) || activityData.professorEmail === currentUser?.email;
                        
                        if (isRelevant && activityData.type === 'test') {
                            allTests.push({
                                id: docSnap.id,
                                name: activityData.title || activityData.name || 'Activity Test',
                                section: activityData.section || 'No Section',
                                date: activityData.createdAt?.toDate() || new Date(),
                                deadlineDateTime: activityData.dueDate?.toDate() || new Date(),
                                status: 'active',
                                ...activityData
                            });
                        }
                    });
                } catch (error) {
                    console.log('No activities collection data');
                }
                
                console.log('âœ… Total tests loaded:', allTests.length);
                
                // Update tests badge
                updateTabBadges();
                
                // Refresh tests display if tab is active
                const testsTab = document.getElementById('testsTab');
                if (testsTab && testsTab.classList.contains('active')) {
                    populateSortFilters();
                    displayAllTests();
                }
                
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        // Load test completions and organize by student
        async function loadTestCompletions() {
            try {
                testCompletions.clear();
                studentTestResults.clear();
                
                const testResultsQuery = query(
                    collection(db, 'testResults'),
                    where('status', '==', 'completed')
                );
                
                const testResultsSnapshot = await getDocs(testResultsQuery);
                
                testResultsSnapshot.forEach((docSnap) => {
                    const result = docSnap.data();
                    const testId = result.testId || result.scheduledTestId;
                    const studentEmail = result.studentEmail || result.email;
                    const testName = result.testName || 'Unknown Test';
                    
                    if (testId && studentEmail) {
                        // For test completions map (simple set of who completed)
                        if (!testCompletions.has(testId)) {
                            testCompletions.set(testId, new Set());
                        }
                        testCompletions.get(testId).add(studentEmail);
                        
                        // For detailed student results
                        if (!studentTestResults.has(studentEmail)) {
                            studentTestResults.set(studentEmail, new Map());
                        }
                        
                        const studentTests = studentTestResults.get(studentEmail);
                        if (!studentTests.has(testId)) {
                            studentTests.set(testId, {
                                attempts: [],
                                bestScore: 0,
                                testName: testName
                            });
                        }
                        
                        // Calculate score
                        const score = calculateTestScore(testName, result.result || result.resultData || result, result.testTarget);
                        
                        const testAttempt = {
                            id: docSnap.id,
                            attemptNumber: result.attemptNumber || 1,
                            score: score,
                            result: result.result || result.resultData || result.repetitions || 'N/A',
                            submittedAt: result.submittedAt?.toDate() || new Date(),
                            testName: testName
                        };
                        
                        studentTests.get(testId).attempts.push(testAttempt);
                        
                        // Update best score
                        if (score > studentTests.get(testId).bestScore) {
                            studentTests.get(testId).bestScore = score;
                        }
                        
                        // Sort attempts by date
                        studentTests.get(testId).attempts.sort((a, b) => b.submittedAt - a.submittedAt);
                    }
                });
                
                console.log('âœ… Test completions loaded');
                
            } catch (error) {
                console.error('Error loading test completions:', error);
            }
        }

        // Calculate test score
        function calculateTestScore(testName, result, testTarget = null) {
            const normalized = testName.toLowerCase().trim();
            
            // Check for professor override
            if (result && typeof result === 'object' && result !== null) {
                if (result.score !== undefined && result.score !== null) {
                    const score = parseFloat(result.score);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        return score;
                    }
                }
            }
            
            // Extract numeric value
            let numericValue = 0;
            if (typeof result === 'object' && result !== null) {
                numericValue = result.repetitions || result.time || result.distance || 
                              result.value || result.result || result.count || 
                              result.score || 0;
            } else if (typeof result === 'string') {
                const match = result.match(/(\d+\.?\d*)/);
                if (match) {
                    numericValue = parseFloat(match[1]);
                } else {
                    numericValue = parseFloat(result) || 0;
                }
            } else {
                numericValue = parseFloat(result) || 0;
            }
            
            // Use test target if available
            if (testTarget && testTarget > 0) {
                if (normalized.includes('push-up') || normalized.includes('pushup') || 
                    normalized.includes('sit-up') || normalized.includes('situp') ||
                    normalized.includes('curl-up')) {
                    
                    const reps = numericValue;
                    if (reps >= testTarget) return 100;
                    
                    const percentage = (reps / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return score;
                }
                
                if (normalized.includes('plank')) {
                    let seconds = numericValue;
                    if (seconds >= testTarget) return 100;
                    
                    const percentage = (seconds / testTarget) * 100;
                    let score = Math.min(100, Math.max(50, percentage));
                    
                    if (percentage >= 100) score = 100;
                    else if (percentage >= 90) score = 95;
                    else if (percentage >= 80) score = 90;
                    else if (percentage >= 70) score = 85;
                    else if (percentage >= 60) score = 80;
                    else if (percentage >= 50) score = 75;
                    
                    return score;
                }
            }
            
            // Fallback scoring
            if (normalized.includes('push-up') || normalized.includes('pushup')) {
                const reps = numericValue;
                if (reps >= 40) return 100;
                if (reps >= 35) return 95;
                if (reps >= 30) return 90;
                if (reps >= 25) return 85;
                if (reps >= 20) return 80;
                if (reps >= 15) return 75;
                if (reps >= 10) return 70;
                if (reps >= 5) return 65;
                return 60;
            }
            
            if (normalized.includes('curl-up')) {
                const reps = numericValue;
                if (reps >= 75) return 100;
                if (reps >= 60) return 95;
                if (reps >= 50) return 90;
                if (reps >= 40) return 85;
                if (reps >= 30) return 80;
                if (reps >= 25) return 75;
                if (reps >= 20) return 70;
                return 65;
            }
            
            return 75;
        }

        // Get score class
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 75) return 'score-good';
            if (score >= 60) return 'score-average';
            return 'score-poor';
        }

        // Populate sort filters with unique values
        function populateSortFilters() {
            const sectionFilter = document.getElementById('sortBySection');
            const nameFilter = document.getElementById('sortByName');
            
            if (!sectionFilter || !nameFilter) return;
            
            // Clear existing options except first
            while (sectionFilter.options.length > 1) sectionFilter.remove(1);
            while (nameFilter.options.length > 1) nameFilter.remove(1);
            
            // Get unique sections
            const uniqueSections = [...new Set(allTests.map(t => t.section))].sort();
            uniqueSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });
            
            // Get unique test names
            const uniqueNames = [...new Set(allTests.map(t => t.name))].sort();
            uniqueNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                nameFilter.appendChild(option);
            });
        }

        // Apply test filters
        function applyTestFilters() {
            selectedSection = document.getElementById('sortBySection').value;
            selectedTestName = document.getElementById('sortByName').value;
            selectedDateOrder = document.getElementById('sortByDate').value;
            
            displayAllTests();
        }

        // Reset all filters
        window.resetSortFilters = function() {
            document.getElementById('sortBySection').value = '';
            document.getElementById('sortByName').value = '';
            document.getElementById('sortByDate').value = '';
            
            selectedSection = '';
            selectedTestName = '';
            selectedDateOrder = '';
            
            displayAllTests();
        };

        // Apply test sort (called from onchange)
        window.applyTestSort = function() {
            applyTestFilters();
        };

        // Filter and sort tests
        function filterAndSortTests() {
            let filtered = [...allTests];
            
            // Filter by section
            if (selectedSection) {
                filtered = filtered.filter(t => t.section === selectedSection);
            }
            
            // Filter by test name
            if (selectedTestName) {
                filtered = filtered.filter(t => t.name === selectedTestName);
            }
            
            // Sort by date
            if (selectedDateOrder) {
                filtered.sort((a, b) => {
                    const dateA = new Date(a.date || a.createdAt || 0);
                    const dateB = new Date(b.date || b.createdAt || 0);
                    return selectedDateOrder === 'newest' ? dateB - dateA : dateA - dateB;
                });
            }
            
            return filtered;
        }

        // Display all tests with filters
        function displayAllTests() {
            const allTestsList = document.getElementById('allTestsList');
            
            if (!allTestsList) return;
            
            if (allTests.length === 0) {
                allTestsList.innerHTML = `
                    <div class="text-center py-10 col-span-full">
                        <div class="text-4xl text-gray-300 mb-4">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="text-gray-500 font-medium">No tests found</div>
                        <div class="text-sm text-gray-400 mt-2">Tests will appear here when created</div>
                    </div>
                `;
                return;
            }
            
            // Apply filters and sorting
            const filteredTests = filterAndSortTests();
            
            if (filteredTests.length === 0) {
                allTestsList.innerHTML = `
                    <div class="text-center py-10 col-span-full">
                        <div class="text-4xl text-gray-300 mb-4">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="text-gray-500 font-medium">No tests match your filters</div>
                        <div class="text-sm text-gray-400 mt-2">Try adjusting your filter criteria</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredTests.forEach(test => {
                const testId = test.id;
                const completions = testCompletions.get(testId) || new Set();
                
                // Get students in this test's section
                const sectionStudents = allStudents.filter(s => s.section === test.section);
                const totalStudents = sectionStudents.length;
                const completedCount = Array.from(completions).filter(email => 
                    sectionStudents.some(s => s.email === email)
                ).length;
                
                const completionRate = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
                
                const statusColor = test.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                
                html += `
                    <div class="test-card" onclick="window.openTestModal('${test.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-gray-900 font-bold text-lg truncate" style="max-width: 70%;">${test.name}</h4>
                            <span class="text-xs ${statusColor} px-2 py-1 rounded-full whitespace-nowrap">${test.status}</span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-chalkboard-teacher w-4"></i>
                                <span class="test-section-badge">${test.section}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users w-4"></i>
                                ${completedCount}/${totalStudents} completed
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar w-4"></i>
                                ${new Date(test.date || test.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                        <div class="mt-2 text-right text-xs text-gray-500">
                            ${completionRate}% completion rate
                        </div>
                    </div>
                `;
            });
            
            allTestsList.innerHTML = html;
            
            // Update time
            const testsUpdateTime = document.getElementById('testsUpdateTime');
            if (testsUpdateTime) {
                testsUpdateTime.textContent = `Updated: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
        }

        // Open test modal
        window.openTestModal = function(testId) {
            const test = allTests.find(t => t.id === testId);
            if (!test) return;
            
            currentTestData = {
                test: test,
                students: allStudents.filter(s => s.section === test.section),
                completions: testCompletions.get(testId) || new Set()
            };
            
            // Get all test results for this test
            const testResults = [];
            if (studentTestResults.size > 0) {
                studentTestResults.forEach((studentTests, email) => {
                    if (studentTests.has(testId)) {
                        const studentData = allStudents.find(s => s.email === email);
                        if (studentData) {
                            const testInfo = studentTests.get(testId);
                            testResults.push({
                                studentEmail: email,
                                studentName: studentData.name || email.split('@')[0],
                                bestScore: testInfo.bestScore,
                                attempts: testInfo.attempts
                            });
                        }
                    }
                });
            }
            
            // Prepare modal data with student details
            currentModalStudents = currentTestData.students.map(student => {
                const hasTaken = currentTestData.completions.has(student.email);
                const studentResult = testResults.find(r => r.studentEmail === student.email);
                
                return {
                    ...student,
                    hasTaken: hasTaken,
                    bestScore: studentResult?.bestScore || 0,
                    attempts: studentResult?.attempts || []
                };
            });
            
            // Group by section
            const sections = [...new Set(currentModalStudents.map(s => s.section))];
            
            // Display modal
            displayTestModal(sections);
        };

        // Display test modal
        function displayTestModal(sections) {
            const modal = document.getElementById('testDetailModal');
            const modalTestTitle = document.getElementById('modalTestTitle');
            const modalTestSection = document.getElementById('modalTestSection');
            const modalTotalStudents = document.getElementById('modalTotalStudents');
            const modalCompletedCount = document.getElementById('modalCompletedCount');
            const modalNotTakenCount = document.getElementById('modalNotTakenCount');
            const modalCompletionRate = document.getElementById('modalCompletionRate');
            const modalProgressBar = document.getElementById('modalProgressBar');
            const modalSectionTabs = document.getElementById('modalSectionTabs');
            
            // Set basic info
            modalTestTitle.textContent = currentTestData.test.name;
            modalTestSection.textContent = `Section: ${currentTestData.test.section}`;
            
            // Calculate totals
            const totalStudents = currentModalStudents.length;
            const completedCount = currentModalStudents.filter(s => s.hasTaken).length;
            const notTakenCount = totalStudents - completedCount;
            const completionRate = totalStudents > 0 ? Math.round((completedCount / totalStudents) * 100) : 0;
            
            modalTotalStudents.textContent = totalStudents;
            modalCompletedCount.textContent = completedCount;
            modalNotTakenCount.textContent = notTakenCount;
            modalCompletionRate.textContent = `${completionRate}%`;
            modalProgressBar.style.width = `${completionRate}%`;
            
            // Update stats in filter area
            document.getElementById('takenCount').textContent = completedCount;
            document.getElementById('notTakenCount').textContent = notTakenCount;
            
            // Create section tabs
            let sectionTabsHtml = '';
            sections.forEach((section, index) => {
                const isActive = index === 0;
                if (isActive) currentSelectedSection = section;
                sectionTabsHtml += `
                    <div class="section-tab ${isActive ? 'active' : ''}" onclick="switchTestSection('${section}')">
                        ${section}
                    </div>
                `;
            });
            
            // If no sections, show default
            if (sections.length === 0) {
                sectionTabsHtml = '<div class="section-tab active">All Students</div>';
                currentSelectedSection = 'All Students';
            }
            
            modalSectionTabs.innerHTML = sectionTabsHtml;
            
            // Reset filters
            document.getElementById('studentStatusFilter').value = 'all';
            document.getElementById('studentSortBy').value = 'name';
            document.getElementById('studentSearch').value = '';
            
            // Display students for first section
            filterModalStudents();
            
            // Show modal
            modal.classList.add('active');
        }

        // Switch test section
        window.switchTestSection = function(section) {
            currentSelectedSection = section;
            
            // Update active class on tabs
            document.querySelectorAll('.section-tab').forEach(tab => {
                if (tab.textContent.trim() === section) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update list title
            document.getElementById('modalListTitle').textContent = `Students in ${section}`;
            
            // Re-filter students
            filterModalStudents();
        };

        // Filter modal students
        window.filterModalStudents = function() {
            const statusFilter = document.getElementById('studentStatusFilter').value;
            const sortBy = document.getElementById('studentSortBy').value;
            const searchText = document.getElementById('studentSearch').value.toLowerCase();
            
            // Filter by section first
            let filtered = currentModalStudents;
            if (currentSelectedSection && currentSelectedSection !== 'All Students') {
                filtered = filtered.filter(s => s.section === currentSelectedSection);
            }
            
            // Filter by status
            if (statusFilter === 'taken') {
                filtered = filtered.filter(s => s.hasTaken);
            } else if (statusFilter === 'not-taken') {
                filtered = filtered.filter(s => !s.hasTaken);
            }
            
            // Filter by search
            if (searchText) {
                filtered = filtered.filter(s => 
                    (s.name && s.name.toLowerCase().includes(searchText)) ||
                    (s.email && s.email.toLowerCase().includes(searchText))
                );
            }
            
            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'name') {
                    return (a.name || a.email || '').localeCompare(b.name || b.email || '');
                } else if (sortBy === 'email') {
                    return (a.email || '').localeCompare(b.email || '');
                } else if (sortBy === 'score') {
                    return (b.bestScore || 0) - (a.bestScore || 0);
                }
                return 0;
            });
            
            currentFilteredStudents = filtered;
            
            // Update displayed count
            document.getElementById('displayedCount').textContent = 
                `Showing ${filtered.length} of ${currentModalStudents.length} students`;
            
            // Render students
            renderModalStudents();
        };

        // Render students in modal
        function renderModalStudents() {
            const modalStudentList = document.getElementById('modalStudentList');
            
            if (currentFilteredStudents.length === 0) {
                modalStudentList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-graduate text-4xl mb-2"></i>
                        <p>No students match your filters</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            currentFilteredStudents.forEach(student => {
                const hasTaken = student.hasTaken;
                const studentName = student.name || student.email?.split('@')[0] || 'Student';
                const studentEmail = student.email || '';
                const initials = studentName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                const scoreClass = getScoreClass(student.bestScore);
                
                html += `
                    <div class="student-list-item">
                        <div class="student-info">
                            <div class="student-avatar">${initials}</div>
                            <div class="student-details">
                                <div class="student-name">${studentName}</div>
                                <div class="student-email">${studentEmail}</div>
                            </div>
                        </div>
                        <div class="student-score">
                            ${hasTaken ? `
                                <span class="score-badge ${scoreClass}">${student.bestScore}%</span>
                            ` : ''}
                            <span class="student-status-badge ${hasTaken ? 'taken' : 'not-taken'}">
                                ${hasTaken ? 'âœ“ Taken' : 'âœ— Not Taken'}
                            </span>
                            ${hasTaken ? `
                                <button class="view-details-btn" onclick="event.stopPropagation(); viewStudentDetails('${studentEmail}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            modalStudentList.innerHTML = html;
        }

        // View student details
        window.viewStudentDetails = function(studentEmail) {
            const student = allStudents.find(s => s.email === studentEmail);
            const testId = currentTestData.test.id;
            const studentTests = studentTestResults.get(studentEmail)?.get(testId);
            
            if (!student || !studentTests) return;
            
            // Set modal content
            document.getElementById('studentDetailsName').textContent = student.name || studentEmail.split('@')[0];
            document.getElementById('studentDetailsEmail').textContent = studentEmail;
            document.getElementById('studentDetailsTest').textContent = currentTestData.test.name;
            document.getElementById('studentDetailsScore').textContent = `${studentTests.bestScore}%`;
            document.getElementById('studentDetailsStatus').innerHTML = '<span class="text-green-600">Completed</span>';
            
            // Show attempts
            const attemptsContainer = document.getElementById('studentTestAttempts');
            let attemptsHtml = '<h4 class="font-bold mb-3">Test Attempts</h4>';
            
            studentTests.attempts.forEach((attempt, index) => {
                const dateStr = attempt.submittedAt.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                attemptsHtml += `
                    <div class="bg-gray-50 p-4 rounded-lg mb-2">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-semibold">Attempt ${attempt.attemptNumber}</span>
                                <span class="text-sm text-gray-500 ml-2">${dateStr}</span>
                            </div>
                            <span class="score-badge ${getScoreClass(attempt.score)}">${attempt.score}%</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-2">Result: ${attempt.result}</div>
                    </div>
                `;
            });
            
            attemptsContainer.innerHTML = attemptsHtml;
            
            // Show modal
            studentDetailsModal.classList.add('active');
        };

        // Close test modal
        window.closeTestModal = function() {
            testModal.classList.remove('active');
            currentTestData = null;
            currentSelectedSection = null;
            currentModalStudents = [];
            currentFilteredStudents = [];
        };

        // Close student details modal
        window.closeStudentDetailsModal = function() {
            studentDetailsModal.classList.remove('active');
        };

        // Setup real-time presence monitoring
        function setupRealtimePresence() {
            try {
                // Setup presence for professor
                const professorPresenceRef = ref(database, `presence/${currentUser.id}`);
                set(professorPresenceRef, {
                    status: 'online',
                    email: currentUser.email,
                    role: 'professor',
                    lastSeen: rtdbServerTimestamp(),
                    name: currentUser.name || currentUser.displayName
                });
                
                // Update last seen on disconnect
                const disconnectRef = ref(database, '.info/connected');
                onValue(disconnectRef, (snap) => {
                    if (snap.val() === false) return;
                    
                    professorPresenceRef.onDisconnect().set({
                        status: 'offline',
                        email: currentUser.email,
                        role: 'professor',
                        lastSeen: rtdbServerTimestamp(),
                        name: currentUser.name || currentUser.displayName
                    });
                });

                // Monitor student presence
                const presenceRef = ref(database, 'presence');
                onValue(presenceRef, (snapshot) => {
                    onlineStudents.clear();
                    let onlineCount = 0;
                    
                    const presenceData = snapshot.val();
                    if (presenceData) {
                        Object.keys(presenceData).forEach(userId => {
                            const userPresence = presenceData[userId];
                            if (userPresence.status === 'online' && userPresence.role === 'student') {
                                const studentEmail = userPresence.email;
                                const isProfessorsStudent = allStudents.some(student => 
                                    student.email === studentEmail || student.uniqueId === studentEmail
                                );
                                
                                if (isProfessorsStudent) {
                                    onlineStudents.set(userId, {
                                        ...userPresence,
                                        id: userId,
                                        lastSeen: userPresence.lastSeen || new Date().getTime()
                                    });
                                    onlineCount++;
                                }
                            }
                        });
                    }
                    
                    console.log(`ðŸ‘¥ Online Students: ${onlineCount}/${allStudents.length}`);
                    
                    // Update tab badges
                    updateTabBadges();
                });
                
            } catch (error) {
                console.error('âŒ Error setting up presence:', error);
            }
        }

        // Setup real-time test completions listener
        function setupRealtimeTestCompletions() {
            try {
                const testResultsRef = collection(db, 'testResults');
                const testResultsQuery = query(testResultsRef, orderBy('submittedAt', 'desc'), limit(20));
                
                const unsubscribe = onSnapshot(testResultsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const testResult = change.doc.data();
                            const studentEmail = testResult.studentEmail || testResult.email;
                            
                            // Check if this student belongs to professor
                            const isProfessorsStudent = allStudents.some(student => 
                                student.email === studentEmail || student.uniqueId === studentEmail
                            );
                            
                            const isProfessorsSection = assignedSections.some(section => 
                                section.name === testResult.section
                            );
                            
                            if (isProfessorsStudent || isProfessorsSection || testResult.professorEmail === currentUser.email) {
                                const time = testResult.submittedAt?.toDate() || 
                                           testResult.completedAt?.toDate() || 
                                           testResult.timestamp?.toDate() || 
                                           new Date();
                                
                                const studentName = testResult.studentName || testResult.name || 'Student';
                                const testName = testResult.testName || 'Fitness Assessment';
                                const section = testResult.section || 'Unknown Section';
                                
                                // Update test completions
                                const testId = testResult.testId || testResult.scheduledTestId;
                                if (testId && studentEmail) {
                                    if (!testCompletions.has(testId)) {
                                        testCompletions.set(testId, new Set());
                                    }
                                    testCompletions.get(testId).add(studentEmail);
                                }
                                
                                // Add to activity feed
                                addActivityToFeed({
                                    type: 'test',
                                    title: `${studentName} completed ${testName}`,
                                    details: `${section} â€¢ Score: ${testResult.score || 'N/A'}`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 1
                                });
                                
                                // Show notification
                                showNotification('Test Completed', `${studentName} just finished ${testName}`, 'test');
                                
                                // Update tests count
                                updateTestsCount();
                                
                                // Refresh tests display if active
                                const testsTab = document.getElementById('testsTab');
                                if (testsTab && testsTab.classList.contains('active')) {
                                    displayAllTests();
                                }
                            }
                        }
                    });
                });
                
                activeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error setting up test completions listener:', error);
            }
        }

        // Setup real-time student activity listener
        function setupRealtimeStudentActivity() {
            try {
                const studentsRef = collection(db, 'students');
                const studentsQuery = query(studentsRef, where('section', 'in', assignedSections.map(s => s.name)));
                
                const unsubscribe = onSnapshot(studentsQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const studentData = change.doc.data();
                            const oldData = change.oldDoc?.data();
                            
                            // Check for lastLogin update
                            if (studentData.lastLogin && (!oldData?.lastLogin || 
                                studentData.lastLogin.toDate().getTime() > oldData.lastLogin.toDate().getTime())) {
                                
                                const time = studentData.lastLogin.toDate();
                                const studentName = studentData.name || studentData.studentName || 'Student';
                                const section = studentData.section || 'Unknown Section';
                                
                                addActivityToFeed({
                                    type: 'student',
                                    title: `${studentName} logged in`,
                                    details: `${section} â€¢ Accessed the platform`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 3
                                });
                                
                                showNotification('Student Online', `${studentName} just logged in`, 'student');
                            }
                        }
                    });
                });
                
                activeListeners.push(unsubscribe);
                
            } catch (error) {
                console.error('Error setting up student activity listener:', error);
            }
        }

        // Add activity to feed
        function addActivityToFeed(activity) {
            activityFeed.unshift(activity);
            
            // Keep only latest activities
            if (activityFeed.length > MAX_ACTIVITIES) {
                activityFeed = activityFeed.slice(0, MAX_ACTIVITIES);
            }
            
            // Update activity feed if tab is active
            const activityTab = document.getElementById('activityTab');
            if (activityTab && activityTab.classList.contains('active')) {
                displayActivityFeed();
            }
            
            // Update tab badges
            updateTabBadges();
            
            // Update last activity time
            const activityUpdateTime = document.getElementById('activityUpdateTime');
            if (activityUpdateTime) {
                activityUpdateTime.textContent = `Last activity: ${formatTimeAgo(activity.time)}`;
            }
        }

        // Display activity feed
        function displayActivityFeed() {
            const activityTimeline = document.getElementById('activityTimeline');
            const filterValue = document.getElementById('activityTypeFilter')?.value || 'all';
            
            let filteredActivities = activityFeed;
            if (filterValue !== 'all') {
                filteredActivities = activityFeed.filter(activity => activity.type === filterValue);
            }
            
            if (filteredActivities.length === 0) {
                activityTimeline.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-4xl text-gray-300 mb-4">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="text-gray-500 font-medium">No activities found</div>
                        <div class="text-sm text-gray-400 mt-2">Activities will appear here as students interact with the system</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredActivities.forEach((activity, index) => {
                let iconClass = 'system';
                let icon = 'fas fa-info-circle';
                
                if (activity.type === 'test') {
                    iconClass = 'test';
                    icon = 'fas fa-clipboard-check';
                } else if (activity.type === 'student') {
                    iconClass = 'student';
                    icon = 'fas fa-user-graduate';
                } else if (activity.type === 'system') {
                    iconClass = 'system';
                    icon = 'fas fa-cog';
                }
                
                const isRecent = index === 0 && new Date() - activity.time < 30000; // Last 30 seconds
                
                html += `
                    <div class="activity-item ${isRecent ? 'new-activity' : ''}" data-type="${activity.type}">
                        <div class="activity-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-details">${activity.details}</div>
                            <div class="activity-time">
                                ${isRecent ? '<span class="live-indicator"></span>' : ''}
                                ${activity.displayTime}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityTimeline.innerHTML = html;
        }

        // Filter activities
        window.filterActivities = function() {
            displayActivityFeed();
        };

        // Clear activity feed
        window.clearActivityFeed = function() {
            if (confirm('Clear all activity history?')) {
                activityFeed = [];
                displayActivityFeed();
                updateTabBadges();
                showNotification('Activity Feed Cleared', 'All activities have been removed', 'info');
            }
        };

        // Update tests count
        async function updateTestsCount() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const testResultsQuery = query(
                    collection(db, 'testResults'),
                    where('submittedAt', '>=', Timestamp.fromDate(today))
                );
                
                const testResultsSnapshot = await getDocs(testResultsQuery);
                let todayCount = 0;
                
                testResultsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const studentEmail = data.studentEmail || data.email;
                    const isProfessorsStudent = allStudents.some(student => 
                        student.email === studentEmail || student.uniqueId === studentEmail
                    );
                    
                    if (isProfessorsStudent || data.professorEmail === currentUser.email) {
                        todayCount++;
                    }
                });
                
                const totalTestsCount = document.getElementById('totalTestsCount');
                const testsProgress = document.getElementById('testsProgress');
                
                if (totalTestsCount) totalTestsCount.textContent = todayCount.toString();
                if (testsProgress) {
                    const progress = Math.min(100, (todayCount / 50) * 100);
                    testsProgress.style.width = `${progress}%`;
                }
                
                console.log(`ðŸ“Š Tests completed today: ${todayCount}`);
                
            } catch (error) {
                console.error('Error updating tests count:', error);
            }
        }

        // Refresh all tests
        window.refreshAllTests = function() {
            loadTestCompletions().then(() => {
                populateSortFilters();
                displayAllTests();
            });
            showNotification('Refreshing', 'Updating tests list...', 'info');
        };

        // Refresh active tests count
        async function refreshActiveTests() {
            try {
                const now = new Date();
                const activeCount = allTests.filter(test => {
                    const testDate = new Date(test.date);
                    const deadline = new Date(test.deadlineDateTime);
                    return testDate <= now && deadline >= now && test.status === 'active';
                }).length;
                
                const activeTestsCount = document.getElementById('activeTestsCount');
                const activeTestsProgress = document.getElementById('activeTestsProgress');
                
                if (activeTestsCount) activeTestsCount.textContent = activeCount;
                if (activeTestsProgress) {
                    const progress = Math.min(100, (activeCount / 10) * 100);
                    activeTestsProgress.style.width = `${progress}%`;
                }
                
                // Update tab badges
                updateTabBadges();
                
            } catch (error) {
                console.error('Error refreshing active tests:', error);
            }
        }

        // Refresh overview data
        async function refreshOverviewData() {
            await updateTestsCount();
            await refreshActiveTests();
            updateTimeDisplay();
            
            // Update section performance
            displaySectionPerformance();
        }

        // Display section performance
        function displaySectionPerformance() {
            const sectionPerformance = document.getElementById('sectionPerformance');
            if (!sectionPerformance) return;
            
            if (assignedSections.length === 0) {
                sectionPerformance.innerHTML = `
                    <div class="col-span-full text-center py-4 text-gray-500">
                        <i class="fas fa-info-circle"></i>
                        <div class="mt-2">No sections assigned</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            assignedSections.forEach(section => {
                const totalStudents = section.students?.length || 0;
                
                // Get test completion rate for this section
                const sectionTests = allTests.filter(t => t.section === section.name);
                let totalCompletions = 0;
                let totalPossible = 0;
                
                sectionTests.forEach(test => {
                    const completions = testCompletions.get(test.id) || new Set();
                    const sectionStudentsInTest = allStudents.filter(s => s.section === section.name).length;
                    totalCompletions += completions.size;
                    totalPossible += sectionStudentsInTest;
                });
                
                const completionRate = totalPossible > 0 ? Math.round((totalCompletions / totalPossible) * 100) : 0;
                
                html += `
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-gray-900 font-bold">${section.name}</h4>
                            <span class="text-xs ${completionRate > 50 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-1 rounded-full">
                                ${completionRate}% completion
                            </span>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Total Students</span>
                                <span class="font-semibold">${totalStudents}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tests Assigned</span>
                                <span class="font-semibold">${sectionTests.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Course</span>
                                <span class="font-semibold">${section.courseCode || 'PE 3'}</span>
                            </div>
                        </div>
                        <div class="progress-bar mt-3">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                `;
            });
            
            sectionPerformance.innerHTML = html;
        }

        // Settings modal
        window.showSettings = function() {
            alert('Real-time monitoring settings would appear here.\n\nAvailable options:\nâ€¢ Refresh interval\nâ€¢ Notification preferences\nâ€¢ Data retention\nâ€¢ Export options');
        };

        // Refresh all data
        window.refreshAllData = function() {
            showNotification('Refreshing', 'Updating all monitoring data...', 'info');
            refreshOverviewData();
            refreshAllTests();
            displayActivityFeed();
            updateTimeDisplay();
        };

        // Cleanup listeners
        function cleanupListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            if (realtimeUpdateInterval) {
                clearInterval(realtimeUpdateInterval);
            }
        }

        // Initialize real-time monitoring
        async function initializeRealtimeMonitoring(professorEmail) {
            // Load all tests and completions
            await loadAllTests();
            await loadTestCompletions();
            
            // Setup real-time listeners
            setupRealtimePresence();
            setupRealtimeTestCompletions();
            setupRealtimeStudentActivity();
            
            // Initial data load
            await refreshOverviewData();
            await refreshActiveTests();
            
            // Setup periodic updates
            realtimeUpdateInterval = setInterval(() => {
                updateTimeDisplay();
                updateTabBadges();
                
                // Refresh current tab data
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab) {
                    const tabName = activeTab.id.replace('TabBtn', '');
                    switch(tabName) {
                        case 'overview':
                            refreshOverviewData();
                            break;
                        case 'tests':
                            displayAllTests();
                            break;
                        case 'activity':
                            displayActivityFeed();
                            break;
                    }
                }
            }, 30000); // Update every 30 seconds
            
            // Initial notification
            showNotification('Monitoring Started', 'Real-time tracking is now active', 'success');
        }

        // Main initialization
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('=== PROFESSOR AUTHENTICATION ===');
                    const userEmail = user.email.toLowerCase();
                    
                    let professorData = null;
                    let userRole = null;
                    
                    // Check users collection
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        userRole = userData.role;
                        
                        if (userRole !== 'professor' && userRole !== 'professor') {
                            alert('This account is not authorized to access the professor dashboard.');
                            await signOut(auth);
                            window.location.href = '/login/index.html';
                            return;
                        }
                        
                        professorData = userData;
                        
                    } else {
                        // Try email lookup
                        const emailKey = userEmail.replace(/\./g, '_');
                        const emailLookupRef = doc(db, 'usersByEmail', emailKey);
                        const emailLookupSnap = await getDoc(emailLookupRef);
                        
                        if (emailLookupSnap.exists()) {
                            const emailData = emailLookupSnap.data();
                            userRole = emailData.role;
                            
                            if (userRole !== 'professor' && userRole !== 'professor') {
                                alert('This account is not authorized to access the professor dashboard.');
                                await signOut(auth);
                                window.location.href = '/login/index.html';
                                return;
                            }
                            
                            if (emailData.uid) {
                                const actualUserRef = doc(db, 'users', emailData.uid);
                                const actualUserSnap = await getDoc(actualUserRef);
                                if (actualUserSnap.exists()) {
                                    professorData = actualUserSnap.data();
                                }
                            }
                        } else {
                            throw new Error('Professor profile not found. Please contact the administrator.');
                        }
                    }
                    
                    if (!professorData) {
                        throw new Error('Unable to load professor data.');
                    }
                    
                    // Set current professor
                    currentUser = { 
                        id: user.uid, 
                        email: userEmail,
                        ...professorData 
                    };
                    window.currentUser = currentUser;
                    
                    // Update profile picture
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    // Load assigned sections and students
                    await loadAssignedSections(user.uid, userEmail);
                    await loadAllStudents();
                    
                    // Initialize real-time monitoring
                    await initializeRealtimeMonitoring(userEmail);
                    
                    // Show main content
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                    // Update tab badges
                    updateTabBadges();
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingScreen.style.display = 'none';
                    alert(error.message || 'Error loading dashboard. Please try again.');
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                }
            } else {
                window.location.href = '/login/index.html';
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupListeners);
    </script>
</body>
</html>