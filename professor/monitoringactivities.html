<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMakFit - Professor Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Manrope:600,800|Inter:300,500,400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * { -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { font-family: 'Inter', Helvetica, sans-serif; }
        
        /* Custom animations */
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Navigation styles */
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        .slide-down {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Custom styles not covered by Tailwind */
        .gradient-text {
            background: linear-gradient(90deg, rgba(245, 158, 11, 1) 0%, rgba(255, 229, 0, 1) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-shadow {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-shadow {
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        .btn-shadow:hover {
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }
        
        .live-dot {
            animation: pulse 2s infinite;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border: 4px solid #f1f5f9;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }
        
        /* Activity Timeline */
        .activity-timeline {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        .activity-item:hover {
            background-color: #f8fafc;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            color: white;
        }
        .activity-icon.professor {
            background: #3b82f6;
        }
        .activity-icon.student {
            background: #10b981;
        }
        .activity-icon.test {
            background: #f59e0b;
        }
        .activity-icon.system {
            background: #6b7280;
        }
        .activity-content {
            flex: 1;
        }
        .activity-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .activity-details {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .activity-time {
            font-size: 12px;
            color: #94a3b8;
            font-weight: 500;
        }
        
        /* Empty State */
        .empty-state { 
            padding: 60px 40px; 
            text-align: center; 
        }
        .empty-icon { 
            font-size: 64px; 
            margin-bottom: 20px; 
            opacity: 0.4; 
        }
        .empty-title { 
            font-family: "Inter", Helvetica; 
            font-weight: 700; 
            color: #1f2937; 
            font-size: 20px; 
            margin-bottom: 12px; 
        }
        .empty-text { 
            font-family: "Inter", Helvetica; 
            font-weight: 400; 
            color: #64748b; 
            font-size: 14px; 
            line-height: 1.6; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .activity-count-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loadingScreen" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col justify-center items-center z-50">
        <div class="spinner"></div>
        <div class="mt-5 text-gray-600 font-medium">Loading System Monitoring...</div>
    </div>
    
    <div id="mainContent" class="hidden">
        <!-- Navigation Banner - SAME AS OTHER PAGES -->
        <nav class="bg-gradient-to-r from-blue-900 to-blue-500 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4 py-3 sm:py-4">
                    <!-- Logo -->
                    <a href="#" class="flex items-center gap-2 sm:gap-3">
                        <span class="text-xl sm:text-2xl md:text-3xl font-extrabold font-manrope bg-gradient-to-r from-yellow-400 to-yellow-200 bg-clip-text text-transparent">
                            UMakFit
                        </span>
                    </a>
                    
                    <!-- Desktop Navigation -->
                    <div class="hidden lg:flex items-center gap-2 flex-wrap">
                        <!-- Dashboard -->
                        <a href="professor-dashboard.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-tachometer-alt"></i> 
                            <span>Dashboard</span>
                        </a>
                        
                        <!-- Student Management -->
                        <a href="studentmanagement.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-users"></i> 
                            <span>Student Management</span>
                        </a>
                        
                        <!-- Add Activities -->
                        <a href="addactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-dumbbell"></i> 
                            <span>Add Activities</span>
                        </a>
                        
                        <!-- Add Lesson -->
                        <a href="addlesson.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-book-open"></i> 
                            <span>Add Lesson</span>
                        </a>
                        
                        <!-- Monitoring Activities -->
                        <a href="monitoringactivities.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-chart-bar"></i> 
                            <span>Monitoring Activities</span>
                        </a>
                        
                        <!-- Grades -->
                        <a href="grades.html" class="px-3 xl:px-4 py-2.5 xl:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-white/30 transition-all">
                            <i class="fas fa-graduation-cap"></i> 
                            <span>Grades</span>
                        </a>
                        
                        <!-- Profile Dropdown -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtn"
                                 class="w-9 h-9 xl:w-10 xl:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 hover:scale-105 transition-all object-cover">
                            
                            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPicture" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownName" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmail" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Right Icons -->
                    <div class="flex lg:hidden items-center gap-2 sm:gap-3">
                        <!-- Mobile Profile -->
                        <div class="relative">
                            <img src="" alt="Profile" id="profilePictureBtnMobile"
                                 class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-white/30 cursor-pointer hover:border-white/60 object-cover">
                            
                            <!-- Mobile Profile Dropdown -->
                            <div id="profileDropdownMobile" class="hidden fixed right-2 top-20 w-64 sm:w-72 bg-white rounded-xl shadow-2xl z-[9999] slide-down">
                                <div class="p-4 sm:p-6 border-b-2 border-gray-200 text-center">
                                    <img src="" alt="Profile" id="profileDropdownPictureMobile" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full mx-auto mb-2 sm:mb-3 border-3 border-blue-500 object-cover">
                                    <h6 id="profileDropdownNameMobile" class="font-bold text-gray-900 text-base sm:text-lg">Loading...</h6>
                                    <p id="profileDropdownEmailMobile" class="text-xs sm:text-sm text-gray-500 mt-1 truncate px-2">Loading...</p>
                                </div>
                                <div class="p-2">
                                    <a href="#" onclick="showViewProfile(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <i class="bi bi-person-circle text-blue-500 text-lg sm:text-xl"></i>
                                        <span class="font-medium text-gray-700 text-sm sm:text-base">View Profile</span>
                                    </a>
                                    <div class="h-px bg-gray-200 my-1 sm:my-2"></div>
                                    <div onclick="handleLogout(event)" class="flex items-center gap-3 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg hover:bg-red-50 transition-colors cursor-pointer text-red-500">
                                        <i class="fas fa-sign-out-alt text-lg sm:text-xl"></i>
                                        <span class="font-medium text-sm sm:text-base">Logout</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <button id="mobileMenuButton" class="text-white p-1 sm:p-2">
                            <i class="bi bi-list text-2xl sm:text-3xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Navigation Menu -->
                <div id="mobileMenu" class="hidden lg:hidden mt-3 sm:mt-4 space-y-2 pb-3">
                    <a href="professor-dashboard.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                    </a>
                    <a href="studentmanagement.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-users mr-2"></i> Student Management
                    </a>
                    <a href="addactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-dumbbell mr-2"></i> Add Activities
                    </a>
                    <a href="addlesson.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-book-open mr-2"></i> Add Lesson
                    </a>
                    <a href="monitoringactivities.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white text-gray-900 rounded-lg font-semibold text-sm">
                        <i class="fas fa-chart-bar mr-2"></i> Monitoring Activities
                    </a>
                    <a href="grades.html" class="block px-3 sm:px-4 py-2.5 sm:py-3 bg-white/20 text-white rounded-lg font-semibold text-sm">
                        <i class="fas fa-graduation-cap mr-2"></i> Grades
                    </a>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen pt-10 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Page Header -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-8 mb-10">
                    <div class="flex items-center mb-5">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center mr-4">
                            <i class="fas fa-desktop text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-blue-900 font-bold text-3xl">System Monitoring Dashboard</h1>
                            <p class="text-gray-600 font-medium text-base mt-2">Real-time monitoring of student activity and system performance</p>
                            <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg" onclick="refreshAllData()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Refresh Data</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Overview -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-chart-bar"></i>
                            Student Statistics
                        </h3>
                        <div class="flex items-center space-x-2 bg-green-50 text-green-700 font-semibold text-sm py-1.5 px-4 rounded-full border border-green-200">
                            <div class="w-2 h-2 bg-green-500 rounded-full live-dot"></div>
                            <span>Live Updates</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-5">
                        <!-- Total Students -->
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl text-white p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-user-graduate text-sm md:text-base"></i>
                                <span class="font-semibold text-xs md:text-sm">Total Students</span>
                            </div>
                            <div class="font-extrabold text-2xl md:text-3xl" id="totalStudentsCount">0</div>
                            <div class="flex items-center text-sm opacity-90 mt-2">
                                <i class="fas fa-user-check mr-1"></i>
                                <span>In your sections</span>
                            </div>
                        </div>
                        
                        <!-- Online Students -->
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl text-white p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-wifi text-sm md:text-base"></i>
                                <span class="font-semibold text-xs md:text-sm">Online Students</span>
                            </div>
                            <div class="font-extrabold text-2xl md:text-3xl" id="onlineStudentsCount">0</div>
                            <div class="flex items-center text-sm opacity-90 mt-2">
                                <span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>
                                <span>Active Now</span>
                            </div>
                        </div>
                        
                        <!-- Tests Completed -->
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl text-white p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-clipboard-check text-sm md:text-base"></i>
                                <span class="font-semibold text-xs md:text-sm">Tests Completed</span>
                            </div>
                            <div class="font-extrabold text-2xl md:text-3xl" id="totalTestsCount">0</div>
                            <div class="text-sm opacity-90 mt-2">This Semester</div>
                        </div>
                        
                        <!-- Active Tests -->
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl text-white p-6 transition-all hover:-translate-y-1 hover:shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full translate-x-10 -translate-y-10"></div>
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-running text-sm md:text-base"></i>
                                <span class="font-semibold text-xs md:text-sm">Active Tests</span>
                            </div>
                            <div class="font-extrabold text-2xl md:text-3xl" id="activeTestsCount">0</div>
                            <div class="flex items-center text-sm opacity-90 mt-2">
                                <span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>
                                <span>In Progress</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="bg-white rounded-2xl card-shadow border border-gray-200 p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6">
                        <h3 class="text-gray-900 font-bold text-xl flex items-center gap-2">
                            <i class="fas fa-history"></i>
                            Recent Student Activity
                        </h3>
                        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                            <div class="flex items-center space-x-2">
                                <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="activityTypeFilter" onchange="filterActivities()">
                                    <option value="all">All Activities</option>
                                    <option value="test">Test Activities</option>
                                    <option value="student">Student Activities</option>
                                    <option value="system">System Activities</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="activity-timeline" id="activityTimeline">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="empty-title">Loading Recent Activity</div>
                            <div class="empty-text">Fetching activity data from the system...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gradient-to-b from-gray-900 to-gray-950 mt-10 py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h4 class="text-yellow-500 font-bold text-lg text-center mb-5">About CTBL</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The Center for Technology Based Learning serves as the learning management system operating hub, 
                        reporting to the university MANCOM officials, with a director on duty who manages and handles the 
                        center's daily operations.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        Working closely with the Office of the President, the Center for Information Technology, and the 
                        Deans and Directors to support the LMS end-users' day-to-day activity.
                    </div>
                    <div class="text-gray-300 text-sm leading-relaxed">
                        The center focuses on implementing new forms of training and determining the validity of data to 
                        support the university's educational objectives.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgaLunqEf2gs6dSpF_sz1hV5XQ5Wm52jo",
            authDomain: "umakfit-e3b1d.firebaseapp.com",
            projectId: "umakfit-e3b1d",
            storageBucket: "umakfit-e3b1d.appspot.com",
            messagingSenderId: "276569891504",
            appId: "1:276569891504:web:39b1732b519f4d8b785175"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const database = getDatabase(app);

        // Global variables
        let currentUser = null;
        let allActivities = [];
        let assignedSections = [];
        let allStudents = [];

        // DOM Elements for navigation
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        const profilePictureBtn = document.getElementById('profilePictureBtn');
        const profilePictureBtnMobile = document.getElementById('profilePictureBtnMobile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileDropdownMobile = document.getElementById('profileDropdownMobile');

        // Event Listeners for navigation
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile menu toggle
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', toggleMobileMenu);
            }
            
            // Profile dropdowns
            if (profilePictureBtn) {
                profilePictureBtn.addEventListener('click', toggleProfileDropdown);
            }
            
            if (profilePictureBtnMobile) {
                profilePictureBtnMobile.addEventListener('click', toggleProfileDropdown);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', closeAllDropdowns);
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // Profile dropdown
        function toggleProfileDropdown(event) {
            event?.stopPropagation();
            const isMobile = window.innerWidth < 1024;
            const dropdown = isMobile ? profileDropdownMobile : profileDropdown;
            
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                document.body.classList.add('dropdown-open');
            } else {
                dropdown.classList.add('hidden');
                document.body.classList.remove('dropdown-open');
            }
        }

        function closeProfileDropdown() {
            profileDropdown.classList.add('hidden');
            profileDropdownMobile.classList.add('hidden');
            document.body.classList.remove('dropdown-open');
        }

        // Close all dropdowns when clicking outside
        function closeAllDropdowns(event) {
            if (!event.target.closest('#profilePictureBtn') && 
                !event.target.closest('#profilePictureBtnMobile') && 
                !event.target.closest('#profileDropdown') && 
                !event.target.closest('#profileDropdownMobile')) {
                closeProfileDropdown();
            }
        }

        // View profile function
        window.showViewProfile = function(event) { 
            if (event) event.preventDefault();
            alert('Profile view would open here');
            closeProfileDropdown();
        };

        // Logout function
        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            closeProfileDropdown();
            
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    window.location.href = '/login/index.html';
                }
            }
        };

        // Function to update profile picture
        function updateProfilePicture(photoURL, userName) {
            const profileBtn = document.getElementById('profilePictureBtn');
            const profileBtnMobile = document.getElementById('profilePictureBtnMobile');
            const dropdownPic = document.getElementById('profileDropdownPicture');
            const dropdownPicMobile = document.getElementById('profileDropdownPictureMobile');
            
            const displayName = currentUser?.name || currentUser?.displayName || userName || 'Professor';
            const email = currentUser?.email || 'professor@umak.edu.ph';
            
            // Use provided photo URL or create initial avatar
            const photoUrlToUse = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=3b82f6&color=fff&size=128`;
            
            // Update all profile pictures
            if (profileBtn) profileBtn.src = photoUrlToUse;
            if (profileBtnMobile) profileBtnMobile.src = photoUrlToUse;
            if (dropdownPic) dropdownPic.src = photoUrlToUse;
            if (dropdownPicMobile) dropdownPicMobile.src = photoUrlToUse;
            
            // Update names
            const dropdownName = document.getElementById('profileDropdownName');
            const dropdownNameMobile = document.getElementById('profileDropdownNameMobile');
            if (dropdownName) dropdownName.textContent = displayName;
            if (dropdownNameMobile) dropdownNameMobile.textContent = displayName;
            
            // Update emails
            const dropdownEmail = document.getElementById('profileDropdownEmail');
            const dropdownEmailMobile = document.getElementById('profileDropdownEmailMobile');
            if (dropdownEmail) dropdownEmail.textContent = email;
            if (dropdownEmailMobile) dropdownEmailMobile.textContent = email;
        }

        // Format time relative to now
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Load professor's assigned sections
        async function loadAssignedSections(professorId, professorEmail) {
            try {
                assignedSections = [];
                console.log('Loading sections for professor:', professorEmail);
                
                // Get professor's full name for matching
                let professorFullName = null;
                
                // Try professors collection
                const profQuery = query(collection(db, 'professors'), where('email', '==', professorEmail));
                const profSnap = await getDocs(profQuery);
                if (!profSnap.empty) {
                    professorFullName = profSnap.docs[0].data().fullName || profSnap.docs[0].data().name;
                }
                
                // Try users collection
                if (!professorFullName) {
                    const userQuery = query(collection(db, 'users'), where('email', '==', professorEmail));
                    const userSnap = await getDocs(userQuery);
                    if (!userSnap.empty) {
                        const userData = userSnap.docs[0].data();
                        professorFullName = userData.fullName || userData.name;
                    }
                }
                
                // Fallback to display name
                if (!professorFullName && currentUser) {
                    professorFullName = currentUser.displayName || professorEmail.split('@')[0].toUpperCase();
                }
                
                console.log('Professor name for matching:', professorFullName);
                
                // Load all sections and match by professor name/email
                const sectionsSnapshot = await getDocs(collection(db, 'sections'));
                
                sectionsSnapshot.forEach((doc) => {
                    const sectionData = doc.data();
                    const dbProfessor = (sectionData.professor || '').toString().trim();
                    
                    // Flexible matching
                    const matches = 
                        dbProfessor === professorFullName ||
                        sectionData.professorEmail === professorEmail ||
                        sectionData.professorId === professorId ||
                        dbProfessor.toUpperCase().includes(professorFullName?.toUpperCase() || '') ||
                        (professorFullName && professorFullName.toUpperCase().includes(dbProfessor.toUpperCase()));
                    
                    if (matches) {
                        console.log(`‚úì Matched section: ${sectionData.name}`);
                        assignedSections.push({
                            id: doc.id,
                            name: sectionData.name,
                            professorEmail: professorEmail,
                            students: sectionData.students || [],
                            ...sectionData
                        });
                    }
                });
                
                console.log('‚úÖ Total sections loaded:', assignedSections.length);
                
            } catch (error) {
                console.error('Error loading assigned sections:', error);
            }
        }

        // Load all students in assigned sections
        async function loadAllStudents() {
            try {
                allStudents = [];
                const studentIds = new Set();
                
                console.log('Loading students from sections:', assignedSections.map(s => s.name));
                
                // Load students from all assigned sections
                for (const section of assignedSections) {
                    // Method 1: Check if section has students array
                    if (section.students && Array.isArray(section.students)) {
                        section.students.forEach(student => {
                            const uniqueId = student.email || student.student_id || student.studentId;
                            if (uniqueId && !studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: uniqueId,
                                    email: student.email,
                                    name: student.name,
                                    umakId: student.student_id || student.studentId,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                    }
                    
                    // Method 2: Query students collection by section name
                    try {
                        const studentsQuery = query(
                            collection(db, 'students'),
                            where('section', '==', section.name)
                        );
                        const studentsSnapshot = await getDocs(studentsQuery);
                        
                        studentsSnapshot.forEach((doc) => {
                            const studentData = doc.data();
                            const uniqueId = studentData.email || studentData.umakId || doc.id;
                            
                            if (!studentIds.has(uniqueId)) {
                                studentIds.add(uniqueId);
                                allStudents.push({
                                    id: doc.id,
                                    ...studentData,
                                    section: section.name,
                                    uniqueId: uniqueId
                                });
                            }
                        });
                        
                        console.log(`‚úì Found ${studentsSnapshot.size} students in section ${section.name}`);
                    } catch (error) {
                        console.log(`No students collection data for section ${section.name}`);
                    }
                }
                
                console.log('‚úÖ Total unique students loaded:', allStudents.length);
                
                // Update total students count
                document.getElementById('totalStudentsCount').textContent = allStudents.length;
                
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('totalStudentsCount').textContent = '0';
            }
        }

        async function loadRecentActivity(professorEmail) {
            try {
                console.log('üïí Loading recent activities from database...');
                const activityTimeline = document.getElementById('activityTimeline');
                
                allActivities = [];
                let totalTestsCount = 0;

                // 1. Get test submissions from testResults for professor's sections
                try {
                    const testResultsRef = collection(db, 'testResults');
                    const testResultsSnapshot = await getDocs(testResultsRef);
                    
                    console.log(`üìä Total testResults documents found: ${testResultsSnapshot.size}`);
                    
                    // Group by testName + section to count completions per section
                    const groupedCompletions = {}; // Format: "testName_section" => { count, students: [], latestTime }
                    const uniqueCompletions = new Set(); // Track unique student+test combinations
                    
                    testResultsSnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        
                        // Check if this test belongs to professor's students
                        const studentEmail = data.studentEmail || data.email;
                        const isProfessorsStudent = allStudents.some(student => 
                            student.email === studentEmail || student.uniqueId === studentEmail
                        );
                        
                        const isProfessorsSection = assignedSections.some(section => 
                            section.name === data.section
                        );
                        
                        if (isProfessorsStudent || isProfessorsSection || data.professorEmail === professorEmail) {
                            console.log('üìÑ Test Result Document:', docSnap.id, data);
                            
                            // Create unique key for student + test
                            const uniqueKey = `${studentEmail}_${data.testName}`;
                            
                            // Only count if this is a new completion (avoid counting multiple attempts)
                            if (!uniqueCompletions.has(uniqueKey)) {
                                uniqueCompletions.add(uniqueKey);
                                totalTestsCount++;
                                
                                // Group by test + section
                                const groupKey = `${data.testName}_${data.section}`;
                                
                                let time = null;
                                if (data.submittedAt) {
                                    time = data.submittedAt.toDate();
                                } else if (data.completedAt) {
                                    time = data.completedAt.toDate();
                                } else if (data.timestamp) {
                                    time = data.timestamp.toDate();
                                } else if (data.createdAt) {
                                    time = data.createdAt.toDate();
                                } else {
                                    time = new Date();
                                }
                                
                                if (!groupedCompletions[groupKey]) {
                                    groupedCompletions[groupKey] = {
                                        testName: data.testName || 'Fitness Assessment',
                                        section: data.section || 'Unknown Section',
                                        count: 0,
                                        students: [],
                                        latestTime: time,
                                        timestamp: time.getTime()
                                    };
                                }
                                
                                groupedCompletions[groupKey].count++;
                                groupedCompletions[groupKey].students.push(data.studentName || 'Student');
                                
                                // Update latest time if this completion is more recent
                                if (time > groupedCompletions[groupKey].latestTime) {
                                    groupedCompletions[groupKey].latestTime = time;
                                    groupedCompletions[groupKey].timestamp = time.getTime();
                                }
                            }
                        }
                    });
                    
                    // Convert grouped completions to activities with student count from section
                    for (const [groupKey, group] of Object.entries(groupedCompletions)) {
                        const completedCount = group.count;
                        const testName = group.testName;
                        const sectionName = group.section;
                        
                        // Get total students in this section
                        const sectionInfo = assignedSections.find(s => s.name === sectionName);
                        const totalStudentsInSection = sectionInfo ? sectionInfo.students.length : 0;
                        
                        let title = '';
                        let details = '';
                        
                        if (completedCount === 1) {
                            title = `${group.students[0]} completed ${testName}`;
                            details = `${sectionName} ‚Ä¢ 1/${totalStudentsInSection} student completed`;
                        } else if (completedCount <= 3) {
                            title = `${group.students.join(', ')} completed ${testName}`;
                            details = `${sectionName} ‚Ä¢ ${completedCount}/${totalStudentsInSection} students completed`;
                        } else {
                            title = `${completedCount} students completed ${testName}`;
                            details = `${sectionName} ‚Ä¢ ${completedCount}/${totalStudentsInSection} students completed`;
                        }
                        
                        console.log('‚úÖ Adding grouped test activity:', title, details);
                        
                        allActivities.push({
                            type: 'test',
                            title: title,
                            details: details,
                            time: group.latestTime,
                            displayTime: formatTimeAgo(group.latestTime),
                            timestamp: group.timestamp,
                            priority: 1,
                            studentCount: completedCount,
                            totalStudents: totalStudentsInSection
                        });
                    }
                    
                    console.log(`‚úÖ Counted ${totalTestsCount} unique test completions for professor`);
                    console.log(`üìä Created ${Object.keys(groupedCompletions).length} grouped activities`);
                } catch (error) {
                    console.error('‚ùå Error loading test results:', error);
                }

                // Update total tests count
                document.getElementById('totalTestsCount').textContent = totalTestsCount;

                // 2. Get scheduled tests from professors
                try {
                    const scheduledTestsSnapshot = await getDocs(collection(db, 'scheduledTests'));
                    
                    scheduledTestsSnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        
                        if (data.professorEmail === professorEmail || 
                            assignedSections.some(section => section.name === data.section)) {
                            
                            let time = null;
                            
                            if (data.createdAt) {
                                time = data.createdAt.toDate();
                            } else if (data.scheduledAt) {
                                time = data.scheduledAt.toDate();
                            } else if (data.timestamp) {
                                time = data.timestamp.toDate();
                            } else {
                                time = new Date();
                            }
                            
                            const professorName = data.professorName || data.professor || 'Professor';
                            const testName = data.testName || data.name || 'new assessment';
                            const section = data.section || data.sectionName;
                            
                            allActivities.push({
                                type: 'test',
                                title: `${professorName} scheduled ${testName}`,
                                details: section ? `Assigned to ${section} section` : 'New assessment created',
                                time: time,
                                displayTime: formatTimeAgo(time),
                                timestamp: time.getTime(),
                                priority: 2
                            });
                        }
                    });
                    console.log(`‚úÖ Found scheduled tests for professor`);
                } catch (error) {
                    console.log('‚ÑπÔ∏è No scheduled tests found:', error.message);
                }

                // 3. Get student enrollments and logins
                try {
                    const studentsSnapshot = await getDocs(collection(db, 'students'));
                    
                    studentsSnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const studentName = data.name || data.studentName || 'Student';
                        const section = data.section || data.sectionName || 'Unknown Section';
                        
                        if (assignedSections.some(s => s.name === section)) {
                            // Student enrollment activity
                            if (data.createdAt) {
                                const time = data.createdAt.toDate();
                                allActivities.push({
                                    type: 'student',
                                    title: `${studentName} enrolled in UMakFit`,
                                    details: `${section} ‚Ä¢ Account activated and ready`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 3
                                });
                            }

                            // Student login activity
                            if (data.lastLogin) {
                                const time = data.lastLogin.toDate();
                                allActivities.push({
                                    type: 'student',
                                    title: `${studentName} logged into the platform`,
                                    details: `${section} ‚Ä¢ Accessed student dashboard`,
                                    time: time,
                                    displayTime: formatTimeAgo(time),
                                    timestamp: time.getTime(),
                                    priority: 4
                                });
                            }
                        }
                    });
                    console.log(`‚úÖ Processed student records for professor`);
                } catch (error) {
                    console.log('‚ÑπÔ∏è No student records found:', error.message);
                }

                // 4. Get active tests for professor
                try {
                    let activeTestsCount = 0;
                    
                    const scheduledTestsQuery = query(
                        collection(db, 'scheduledTests'),
                        where('professorEmail', '==', professorEmail)
                    );
                    const scheduledTestsSnapshot = await getDocs(scheduledTestsQuery);
                    
                    const now = new Date();
                    
                    scheduledTestsSnapshot.forEach((docSnap) => {
                        const test = docSnap.data();
                        const testDate = new Date(test.date);
                        const deadlineDateTime = new Date(test.deadlineDateTime);
                        
                        if (testDate <= now && deadlineDateTime >= now && 
                            (test.status === 'active' || test.status === 'scheduled')) {
                            activeTestsCount++;
                            console.log(`‚úÖ Active test: ${test.testName} for ${test.section}`);
                        }
                    });
                    
                    document.getElementById('activeTestsCount').textContent = activeTestsCount;
                    console.log(`üìä Total active tests: ${activeTestsCount}`);
                    
                } catch (error) {
                    console.error('‚ùå Error loading active tests:', error);
                    document.getElementById('activeTestsCount').textContent = '0';
                }

                // Sort all activities - TEST ACTIVITIES ALWAYS FIRST
                allActivities.sort((a, b) => {
                    if (a.priority !== b.priority) {
                        return a.priority - b.priority;
                    }
                    return b.timestamp - a.timestamp;
                });

                console.log('üìä Total activities collected:', allActivities.length);

                // Display activities
                displayActivities(allActivities);

                // Show empty state if no activities
                if (allActivities.length === 0) {
                    activityTimeline.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <div class="empty-title">No Recent Activity</div>
                            <div class="empty-text">There are no recent activities to display. Activities will appear here as students interact with the system.</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Error loading recent activity:', error);
                const activityTimeline = document.getElementById('activityTimeline');
                activityTimeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="empty-title">Error Loading Activities</div>
                        <div class="empty-text">Unable to fetch activity data. Please refresh the page to try again.</div>
                    </div>
                `;
            }
        }

        // Display activities in the timeline
        function displayActivities(activities) {
            const activityTimeline = document.getElementById('activityTimeline');
            activityTimeline.innerHTML = '';

            console.log('üé® Displaying activities:', activities.length);

            if (activities.length === 0) {
                activityTimeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="empty-title">No Activities Found</div>
                        <div class="empty-text">No test completions or activities found in the database. Activities will appear here when students complete assessments.</div>
                    </div>
                `;
                return;
            }

            // Show ALL activities (removed the slice limit to show everything)
            activities.forEach((activity, index) => {
                console.log(`üìù Activity ${index + 1}:`, activity.title);
                const activityItem = createActivityItem(activity);
                activityTimeline.appendChild(activityItem);
            });
            
            console.log(`‚úÖ Displayed ${activities.length} activities in timeline`);
        }

        function createActivityItem(activity) {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.setAttribute('data-type', activity.type);
            
            let iconClass = 'system';
            let icon = 'fas fa-info-circle';
            
            if (activity.type === 'test') {
                iconClass = 'test';
                icon = 'fas fa-clipboard-check';
            } else if (activity.type === 'professor') {
                iconClass = 'professor';
                icon = 'fas fa-user-tie';
            } else if (activity.type === 'student') {
                iconClass = 'student';
                icon = 'fas fa-user-graduate';
            } else if (activity.type === 'system') {
                iconClass = 'system';
                icon = 'fas fa-cog';
            }
            
            // Add completion badge showing X/Y students
            let titleWithBadge = activity.title;
            if (activity.totalStudents && activity.studentCount) {
                titleWithBadge += ` <span class="activity-count-badge">${activity.studentCount}/${activity.totalStudents}</span>`;
            } else if (activity.studentCount && activity.studentCount > 1) {
                titleWithBadge += ` <span class="activity-count-badge">${activity.studentCount} students</span>`;
            }
            
            activityItem.innerHTML = `
                <div class="activity-icon ${iconClass}">
                    <i class="${icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${titleWithBadge}</div>
                    <div class="activity-details">${activity.details}</div>
                    <div class="activity-time">${activity.displayTime}</div>
                </div>
            `;
            
            return activityItem;
        }

        // Filter activities by type
        window.filterActivities = function() {
            const typeFilter = document.getElementById('activityTypeFilter').value;
            
            if (typeFilter === 'all') {
                displayActivities(allActivities);
            } else {
                const filtered = allActivities.filter(activity => activity.type === typeFilter);
                displayActivities(filtered);
            }
        };

        // Setup realtime presence monitoring
        function setupRealtimePresence() {
            try {
                const presenceRef = ref(database, 'presence');
                onValue(presenceRef, (snapshot) => {
                    let onlineStudents = 0;
                    
                    const presenceData = snapshot.val();
                    if (presenceData) {
                        Object.keys(presenceData).forEach(userId => {
                            const userPresence = presenceData[userId];
                            if (userPresence.status === 'online' && userPresence.role === 'student') {
                                // Check if this student is in professor's sections by email
                                const studentEmail = userPresence.email;
                                const isProfessorsStudent = allStudents.some(student => 
                                    student.email === studentEmail || student.uniqueId === studentEmail
                                );
                                
                                if (isProfessorsStudent) {
                                    onlineStudents++;
                                }
                            }
                        });
                    }
                    
                    document.getElementById('onlineStudentsCount').textContent = onlineStudents;
                    
                    console.log(`üë• Online Students in Professor's Sections: ${onlineStudents}`);
                });
            } catch (error) {
                console.error('‚ùå Error setting up presence:', error);
                // Set to 0 if error
                document.getElementById('onlineStudentsCount').textContent = '0';
            }
        }

        // Setup real-time updates for active tests
        function setupActiveTestsListener(professorEmail) {
            try {
                const scheduledTestsQuery = query(
                    collection(db, 'scheduledTests'),
                    where('professorEmail', '==', professorEmail)
                );
                
                onSnapshot(scheduledTestsQuery, (snapshot) => {
                    let activeTestsCount = 0;
                    const now = new Date();
                    
                    snapshot.forEach((docSnap) => {
                        const test = docSnap.data();
                        const testDate = new Date(test.date);
                        const deadlineDateTime = new Date(test.deadlineDateTime);
                        
                        if (testDate <= now && deadlineDateTime >= now && 
                            (test.status === 'active' || test.status === 'scheduled')) {
                            activeTestsCount++;
                        }
                    });
                    
                    document.getElementById('activeTestsCount').textContent = activeTestsCount;
                    console.log(`üîÑ Active tests updated: ${activeTestsCount}`);
                });
                
            } catch (error) {
                console.error('Error setting up active tests listener:', error);
            }
        }
    
        async function loadEnhancedMonitoringData(professorEmail) {
            await loadRecentActivity(professorEmail);
            setupRealtimePresence();
            setupActiveTestsListener(professorEmail); 
        }

        // Refresh all data
        window.refreshAllData = function() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshBtn.disabled = true;
            
            loadEnhancedMonitoringData(currentUser.email).then(() => {
                refreshBtn.innerHTML = '<i class="fas fa-check"></i> Refreshed!';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 1500);
            });
        };

        // Initialize when page loads
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');

            if (user) {
                try {
                    console.log('=== PROFESSOR AUTHENTICATION ===');
                    console.log('User authenticated:', user.email);
                    console.log('User UID:', user.uid);
                    
                    const userEmail = user.email.toLowerCase();
                    
                    let professorData = null;
                    let userRole = null;
                    
                    // Step 1: Check users collection by UID
                    console.log('Step 1: Checking users collection...');
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        userRole = userData.role;
                        console.log('‚úì User found, role:', userRole);
                        
                        // Verify this is a professor account
                        if (userRole !== 'professor' && userRole !== 'professor') {
                            console.error('‚ùå Not a professor account, role is:', userRole);
                            alert('This account is not authorized to access the professor dashboard.');
                            await signOut(auth);
                            window.location.href = '/login/index.html';
                            return;
                        }
                        
                        professorData = userData;
                        console.log('‚úì Professor data loaded from users collection');
                        
                    } else {
                        // Step 2: Try email lookup
                        console.log('Step 2: User not found by UID, checking email lookup...');
                        const emailKey = userEmail.replace(/\./g, '_');
                        const emailLookupRef = doc(db, 'usersByEmail', emailKey);
                        const emailLookupSnap = await getDoc(emailLookupRef);
                        
                        if (emailLookupSnap.exists()) {
                            const emailData = emailLookupSnap.data();
                            userRole = emailData.role;
                            console.log('‚úì Found via email lookup, role:', userRole);
                            
                            if (userRole !== 'professor' && userRole !== 'professor') {
                                console.error('‚ùå Not a professor account');
                                alert('This account is not authorized to access the professor dashboard.');
                                await signOut(auth);
                                window.location.href = '/login/index.html';
                                return;
                            }
                            
                            // Get actual user data
                            if (emailData.uid) {
                                const actualUserRef = doc(db, 'users', emailData.uid);
                                const actualUserSnap = await getDoc(actualUserRef);
                                if (actualUserSnap.exists()) {
                                    professorData = actualUserSnap.data();
                                }
                            }
                        } else {
                            // Step 3: Check professorProfiles as fallback
                            console.log('Step 3: Checking professorProfiles...');
                            const profileRef = doc(db, 'professorProfiles', userEmail);
                            const profileSnap = await getDoc(profileRef);
                            
                            if (profileSnap.exists()) {
                                professorData = profileSnap.data();
                                userRole = 'professor';
                                console.log('‚úì Found in professorProfiles, auto-setting role to professor');
                                
                            } else {
                                throw new Error('Professor profile not found. Please contact the administrator.');
                            }
                        }
                    }
                    
                    if (!professorData) {
                        throw new Error('Unable to load professor data.');
                    }
                    
                    // Set current professor
                    currentUser = { 
                        id: user.uid, 
                        email: userEmail,
                        ...professorData 
                    };
                    console.log('‚úì Current professor set:', currentUser);
                    
                    // Update profile picture with Google photo
                    updateProfilePicture(user.photoURL, user.displayName);
                    
                    // Load professor's assigned sections
                    await loadAssignedSections(user.uid, userEmail);
                    
                    // Load all students in assigned sections
                    await loadAllStudents();
                    
                    // Load monitoring data
                    await loadEnhancedMonitoringData(userEmail);
                    
                    loadingScreen.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('=== ERROR IN AUTHENTICATION ===');
                    console.error('Error:', error);
                    console.error('Error message:', error.message);
                    
                    loadingScreen.style.display = 'none';
                    alert(error.message || 'Error loading dashboard. Please try again.');
                    await signOut(auth);
                    window.location.href = '/login/index.html';
                }
            } else {
                console.log('No user authenticated, redirecting to login...');
                window.location.href = '/login/index.html';
            }
        });
    </script>
</body>
</html>